
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>climada.entity.exposures.litpop &#8212; climada 1.2.4-dev documentation</title>
    <link rel="stylesheet" href="../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../../index.html"><h1 style="font-size: 3em;">climada</h1></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../../../search.html">search</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for climada.entity.exposures.litpop</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file is part of CLIMADA.</span>

<span class="sd">Copyright (C) 2017 ETH Zurich, CLIMADA contributors listed in AUTHORS.</span>

<span class="sd">CLIMADA is free software: you can redistribute it and/or modify it under the</span>
<span class="sd">terms of the GNU Lesser General Public License as published by the Free</span>
<span class="sd">Software Foundation, version 3.</span>

<span class="sd">CLIMADA is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="sd">WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span class="sd">PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU Lesser General Public License along</span>
<span class="sd">with CLIMADA. If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">stdout</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas_datareader</span> <span class="k">import</span> <span class="n">wb</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">nd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">cartopy.io</span> <span class="k">import</span> <span class="n">shapereader</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">shapefile</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">iso3166</span> <span class="k">import</span> <span class="n">countries</span> <span class="k">as</span> <span class="n">iso_cntry</span>
<span class="kn">import</span> <span class="nn">gdal</span>
<span class="kn">from</span> <span class="nn">pint</span> <span class="k">import</span> <span class="n">UnitRegistry</span>

<span class="kn">from</span> <span class="nn">climada.entity.exposures</span> <span class="k">import</span> <span class="n">nightlight</span>
<span class="kn">from</span> <span class="nn">climada.entity.tag</span> <span class="k">import</span> <span class="n">Tag</span>
<span class="kn">from</span> <span class="nn">climada.entity.exposures.base</span> <span class="k">import</span> <span class="n">Exposures</span><span class="p">,</span> <span class="n">INDICATOR_IF</span>
<span class="kn">from</span> <span class="nn">climada.entity.exposures</span> <span class="k">import</span> <span class="n">gpw_import</span>
<span class="kn">from</span> <span class="nn">climada.util.finance</span> <span class="k">import</span> <span class="n">gdp</span><span class="p">,</span> <span class="n">income_group</span><span class="p">,</span> <span class="n">wealth2gdp</span><span class="p">,</span> <span class="n">world_bank_wealth_account</span>
<span class="kn">from</span> <span class="nn">climada.util.constants</span> <span class="k">import</span> <span class="n">SYSTEM_DIR</span>

<span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;Define LitPop class.&quot;&quot;&quot;</span>
<span class="c1"># Black Marble nightlight tile names, %i represents the Black Marble reference year</span>
<span class="n">BM_FILENAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BlackMarble_</span><span class="si">%i</span><span class="s1">_A1_geo_gray.tif&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;BlackMarble_</span><span class="si">%i</span><span class="s1">_A2_geo_gray.tif&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;BlackMarble_</span><span class="si">%i</span><span class="s1">_B1_geo_gray.tif&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;BlackMarble_</span><span class="si">%i</span><span class="s1">_B2_geo_gray.tif&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;BlackMarble_</span><span class="si">%i</span><span class="s1">_C1_geo_gray.tif&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;BlackMarble_</span><span class="si">%i</span><span class="s1">_C2_geo_gray.tif&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;BlackMarble_</span><span class="si">%i</span><span class="s1">_D1_geo_gray.tif&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;BlackMarble_</span><span class="si">%i</span><span class="s1">_D2_geo_gray.tif&#39;</span><span class="p">]</span>
<span class="c1"># years with Black Marble Tiles </span>
<span class="c1"># https://earthobservatory.nasa.gov/features/NightLights/page3.php</span>
<span class="c1"># Update if new years get available!</span>
<span class="n">BM_YEARS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">2012</span><span class="p">]</span> <span class="c1"># latest first</span>
<span class="c1"># Years with GPW population data available:</span>
<span class="n">GPW_YEARS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="mi">2010</span><span class="p">,</span> <span class="mi">2005</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span>

<span class="n">NASA_RESOLUTION_DEG</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="o">*</span><span class="n">UnitRegistry</span><span class="p">()</span><span class="o">.</span><span class="n">arc_second</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">UnitRegistry</span><span class="p">()</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span> \
                       <span class="n">magnitude</span>

<span class="n">WORLD_BANK_INC_GRP</span> <span class="o">=</span> \
<span class="s2">&quot;http://databank.worldbank.org/data/download/site-content/OGHIST.xls&quot;</span>
<span class="sd">&quot;&quot;&quot; Income group historical data from World bank.&quot;&quot;&quot;</span>

<span class="n">DEF_RES_NASA_KM</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="sd">&quot;&quot;&quot; Default approximate resolution for NASA&#39;s nightlights in km.&quot;&quot;&quot;</span>

<span class="n">DEF_RES_GPW_KM</span> <span class="o">=</span> <span class="mi">1</span>
<span class="sd">&quot;&quot;&quot; Default approximate resolution for the GPW dataset in km.&quot;&quot;&quot;</span>

<span class="n">DEF_RES_NASA_ARCSEC</span> <span class="o">=</span> <span class="mi">15</span>
<span class="sd">&quot;&quot;&quot; Default approximate resolution for NASA&#39;s nightlights in arcsec.&quot;&quot;&quot;</span>

<span class="n">DEF_RES_GPW_ARCSEC</span> <span class="o">=</span> <span class="mi">30</span>
<span class="sd">&quot;&quot;&quot; Default approximate resolution for the GPW dataset in arcsec.&quot;&quot;&quot;</span>

<span class="n">DEF_HAZ_TYPE</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="sd">&quot;&quot;&quot; Default hazard type used in impact functions id, i.e. TC &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LitPop"><a class="viewcode-back" href="../../../../climada/climada.entity.exposures.html#climada.entity.exposures.litpop.LitPop">[docs]</a><span class="k">class</span> <span class="nc">LitPop</span><span class="p">(</span><span class="n">Exposures</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines exposures from nightlight intensity (NASA), Gridded Population</span>
<span class="sd">        data (SEDAC), GDP (World Bank) and a conversion factor to calculate</span>
<span class="sd">        asset value from GDP derived from the Global Wealth Databook by the</span>
<span class="sd">        Credit Suisse Research Institute.</span>
<span class="sd">        Calling sequence example:</span>
<span class="sd">        ent = LitPop()</span>
<span class="sd">        country_name = [&#39;Switzerland&#39;, &#39;Austria&#39;]</span>
<span class="sd">        ent.set_country(country_name)</span>
<span class="sd">        ent.plot()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">LitPop</span>

<div class="viewcode-block" id="LitPop.clear"><a class="viewcode-back" href="../../../../climada/climada.entity.exposures.html#climada.entity.exposures.litpop.LitPop.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Appending the base class clear attribute to also delete attributes</span>
<span class="sd">            which are only used here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Exposures</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_data</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="LitPop.set_country"><a class="viewcode-back" href="../../../../climada/climada.entity.exposures.html#climada.entity.exposures.litpop.LitPop.set_country">[docs]</a>    <span class="k">def</span> <span class="nf">set_country</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">countries</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get LitPop based exposre for one country or multiple countries</span>
<span class="sd">        using values at reference year. If GDP or income</span>
<span class="sd">        group not available for that year, consider the value of the closest</span>
<span class="sd">        available year.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            countries (str or list): list of countries or single county as a</span>
<span class="sd">                sting. Countries can either be country names (&#39;France&#39;) or</span>
<span class="sd">                country codes (&#39;FRA&#39;), even a mix is possible in the list.</span>
<span class="sd">        args: Keyword arguments. The following keywords are recognised:</span>
<span class="sd">            res_km (float, optional): approx resolution in km. Default: 1km.</span>
<span class="sd">            res_arcsec (float, optional): resolution in arc-sec. Overrides</span>
<span class="sd">                res_km if both are delivered</span>
<span class="sd">            check_plot (boolean, optional): choose if a plot is shown at the</span>
<span class="sd">                end of the operation.</span>
<span class="sd">            exponents (list of two integers, default = [1, 1]) defining</span>
<span class="sd">                power with which lit (nightlights) and pop (gpw) go into LitPop.</span>
<span class="sd">                To get nightlights^3 alone: [3, 0].</span>
<span class="sd">                To use population count alone: [0, 1].</span>
<span class="sd">            fin_mode (str, optional): define what total country economic value</span>
<span class="sd">                is to be used as an asset base and distributed to the grid:</span>
<span class="sd">                - &#39;gdp&#39;: gross-domestic product (Source: World Bank)</span>
<span class="sd">                - &#39;income_group&#39;: gdp multiplied by country&#39;s income group+1</span>
<span class="sd">                - &#39;nfw&#39;: non-financial wealth (Source: Credit Suisse, of households only)</span>
<span class="sd">                - &#39;tw&#39;: total wealth (Source: Credit Suisse, of households only)</span>
<span class="sd">                - &#39;pc&#39;: produced capital (Source: World Bank), incl. manufactured or</span>
<span class="sd">                    built assets such as machinery, equipment, and physical structures</span>
<span class="sd">                    (pc is in constant 2014 USD)</span>
<span class="sd">                - &#39;norm&#39;: normalized by country</span>
<span class="sd">                - &#39;none&#39;: LitPop per pixel is returned unchanged</span>
<span class="sd">            admin1_calc (boolean): distribute admin1-level GDP if available?</span>
<span class="sd">                (default False)</span>
<span class="sd">            conserve_cntrytotal (boolean): given admin1_calc, conserve national</span>
<span class="sd">            total asset value (default True)</span>
<span class="sd">            reference_year (int)</span>
<span class="sd">            adm1_scatter (boolean): produce scatter plot for admin1 validation?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO: allow for user delivered path</span>
<span class="c1">#        self.clear() # clear existing assets (reset)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">res_km</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;res_km&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res_arcsec</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;res_arcsec&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">fin_mode</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fin_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">)</span>
        <span class="n">exponents</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exponents&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">admin1_calc</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;admin1_calc&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">adm1_scatter</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm1_scatter&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">conserve_cntrytotal</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conserve_cntrytotal&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">reference_year</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reference_year&#39;</span><span class="p">,</span> <span class="mi">2016</span><span class="p">)</span>
        <span class="c1"># bm_year = min(BM_YEARS, key=lambda x:abs(x-reference_year))</span>
<span class="c1">#        inherit_admin1_from_admin0 = args.get(&#39;inherit_admin1_from_admin0&#39;, 1)</span>
        <span class="k">if</span> <span class="n">res_arcsec</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_km</span><span class="o">/</span><span class="n">DEF_RES_GPW_KM</span><span class="p">)</span><span class="o">*</span><span class="n">DEF_RES_GPW_ARCSEC</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">res_arcsec</span>
        <span class="n">_match_target_res</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
        <span class="n">check_plot</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_plot&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">country_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">admin1_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">countries</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1">#multiple countries</span>
            <span class="n">list_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">countries</span><span class="p">)</span>
            <span class="n">country_list</span> <span class="o">=</span> <span class="n">countries</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">country</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">country_list</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">country_new</span> <span class="o">=</span> <span class="n">_get_iso3</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
                <span class="n">country_list</span><span class="p">[</span><span class="n">list_len</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="n">country_new</span>
                <span class="k">if</span> <span class="n">country_new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The country </span><span class="si">%s</span><span class="s1"> could not be found.&#39;</span><span class="p">,</span> <span class="n">country</span><span class="p">)</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Country </span><span class="si">%s</span><span class="s1"> is removed from the list.&#39;</span><span class="p">,</span> <span class="n">country</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">country_list</span><span class="p">[</span><span class="n">list_len</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">country_info</span><span class="p">[</span><span class="n">country_new</span><span class="p">],</span> <span class="n">admin1_info</span><span class="p">[</span><span class="n">country_new</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="n">_get_country_info</span><span class="p">(</span><span class="n">country_new</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">country_new</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">country_list</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No valid country chosen. Operation aborted.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_bbox</span> <span class="o">=</span> <span class="p">[</span><span class="n">_get_country_shape</span><span class="p">(</span><span class="n">countr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>\
                        <span class="k">for</span> <span class="n">countr</span> <span class="ow">in</span> <span class="n">country_list</span><span class="p">]</span>
                <span class="n">cut_bbox</span> <span class="o">=</span> <span class="n">_bbox_union</span><span class="p">(</span><span class="n">all_bbox</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">countries</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1">#One country</span>
            <span class="n">country_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">country_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">countries</span><span class="p">)</span>
            <span class="n">country_new</span> <span class="o">=</span> <span class="n">_get_iso3</span><span class="p">(</span><span class="n">countries</span><span class="p">)</span>
            <span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">country_new</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_get_country_shape</span><span class="p">(</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_bbox</span> <span class="o">=</span> <span class="n">_get_country_shape</span><span class="p">(</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Country </span><span class="si">%s</span><span class="s1"> could not be found.&#39;</span><span class="p">,</span> <span class="n">countries</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="n">cut_bbox</span> <span class="o">=</span> <span class="n">all_bbox</span>
            <span class="n">country_info</span><span class="p">[</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">admin1_info</span><span class="p">[</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>\
                <span class="o">=</span> <span class="n">_get_country_info</span><span class="p">(</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Country parameter data type not recognised. </span><span class="se">\</span>
<span class="s1">                         Operation aborted.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="n">_litpop_box2coords</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Get LitPop</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating LitPop data at a resolution of </span><span class="si">%s</span><span class="s1"> arcsec.&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span>
        <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">_get_litpop_box</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">,</span> \
                                      <span class="n">exponents</span><span class="p">)</span>
        <span class="n">shp_file</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
                                             <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_0_countries&#39;</span><span class="p">)</span>
        <span class="n">shp_file</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">shp_file</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cntry_iso</span><span class="p">,</span> <span class="n">cntry_val</span> <span class="ow">in</span> <span class="n">country_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fin_mode</span> <span class="o">==</span> <span class="s1">&#39;pc&#39;</span><span class="p">:</span>
                <span class="n">total_asset_val</span> <span class="o">=</span> <span class="n">world_bank_wealth_account</span><span class="p">(</span><span class="n">cntry_iso</span><span class="p">,</span> \
                                                               <span class="n">reference_year</span><span class="p">,</span> \
                                                               <span class="n">no_land</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># here, total_asset_val is Produced Capital &quot;pc&quot;</span>
                <span class="c1"># no_land=True returns value w/o the mark-up of 24% for land value</span>
            <span class="k">elif</span> <span class="n">fin_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]:</span>
                <span class="n">total_asset_val</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">total_asset_val</span> <span class="o">=</span> <span class="n">gdp</span><span class="p">(</span><span class="n">cntry_iso</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">,</span> <span class="n">shp_file</span><span class="p">)</span>
            <span class="n">cntry_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_asset_val</span><span class="p">)</span>
        <span class="n">_get_gdp2asset_factor</span><span class="p">(</span><span class="n">country_info</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">,</span> <span class="n">shp_file</span><span class="p">,</span> <span class="n">fin_mode</span><span class="o">=</span><span class="n">fin_mode</span><span class="p">)</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">()</span>
        <span class="n">lp_cntry</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">curr_country</span> <span class="ow">in</span> <span class="n">country_list</span><span class="p">:</span>
            <span class="n">curr_shp</span> <span class="o">=</span> <span class="n">_get_country_shape</span><span class="p">(</span><span class="n">curr_country</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">_mask_from_shape</span><span class="p">(</span><span class="n">curr_shp</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>\
                                    <span class="n">points2check</span><span class="o">=</span><span class="n">all_coords</span><span class="p">)</span>
            <span class="n">litpop_curr</span> <span class="o">=</span> <span class="n">litpop_data</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_coords</span><span class="p">)[</span><span class="n">mask</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fin_mode</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fin_mode=none --&gt; no downscaling; admin1_calc is ignored&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">admin1_calc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">litpop_curr</span> <span class="o">=</span> <span class="n">_calc_admin1</span><span class="p">(</span><span class="n">curr_country</span><span class="p">,</span>\
                                           <span class="n">country_info</span><span class="p">[</span><span class="n">curr_country</span><span class="p">],</span>
                                           <span class="n">admin1_info</span><span class="p">[</span><span class="n">curr_country</span><span class="p">],</span>\
                                           <span class="n">litpop_curr</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)),</span>\
                                           <span class="n">resolution</span><span class="p">,</span> <span class="n">adm1_scatter</span><span class="p">,</span> \
                                           <span class="n">conserve_cntrytotal</span><span class="o">=</span><span class="n">conserve_cntrytotal</span><span class="p">,</span>\
                                           <span class="n">check_plot</span><span class="o">=</span><span class="n">check_plot</span><span class="p">,</span> <span class="n">masks_adm1</span><span class="o">=</span><span class="p">[],</span> <span class="n">return_data</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">litpop_curr</span> <span class="o">=</span> <span class="n">_calc_admin0</span><span class="p">(</span><span class="n">litpop_curr</span><span class="p">,</span>\
                                   <span class="n">country_info</span><span class="p">[</span><span class="n">curr_country</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>\
                                   <span class="n">country_info</span><span class="p">[</span><span class="n">curr_country</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">lp_cntry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_one_country</span><span class="p">(</span><span class="n">country_info</span><span class="p">[</span><span class="n">curr_country</span><span class="p">],</span>\
                <span class="n">litpop_curr</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">curr_country</span><span class="p">))</span>
            <span class="n">tag</span><span class="o">.</span><span class="n">description</span> <span class="o">+=</span> \
                <span class="s1">&#39;LitPop for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%i</span><span class="s1"> as, year=</span><span class="si">%i</span><span class="s1">, financial mode=</span><span class="si">%s</span><span class="s1">, GPW-year=</span><span class="si">%i</span><span class="s1">, BM-year=</span><span class="si">%i</span><span class="s1">, exp=[</span><span class="si">%i</span><span class="s1">, </span><span class="si">%i</span><span class="s1">]&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">country_info</span><span class="p">[</span><span class="n">curr_country</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">,</span> \
                   <span class="n">fin_mode</span><span class="p">,</span> \
                <span class="nb">min</span><span class="p">(</span><span class="n">GPW_YEARS</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">reference_year</span><span class="p">)),</span> \
                <span class="nb">min</span><span class="p">(</span><span class="n">BM_YEARS</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">reference_year</span><span class="p">)),</span> \
                <span class="n">exponents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exponents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Exposures</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">lp_cntry</span><span class="p">,</span>
                                                            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_year</span> <span class="o">=</span> <span class="n">reference_year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_unit</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span>

        <span class="k">if</span> <span class="n">check_plot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_log</span><span class="p">(</span><span class="n">admin1_plot</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating the LitPop exposure took </span><span class="si">%i</span><span class="s2"> s&quot;</span><span class="p">,</span> \
                        <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="c1"># self.set_geometry_points()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_set_one_country</span><span class="p">(</span><span class="n">cntry_info</span><span class="p">,</span> <span class="n">litpop_data</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">curr_country</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Model one country.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cntry_info (list): [cntry_id, cnytry_name, cntry_geometry,</span>
<span class="sd">                ref_year, gdp, income_group]</span>
<span class="sd">            litpop_data (pandas SparseArray): LitPop data with the value</span>
<span class="sd">                already distributed.</span>
<span class="sd">            lon (array): longitudinal coordinates</span>
<span class="sd">            lat (array): latudinal coordinates</span>
<span class="sd">            curr_country: name or iso3 ID of country</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lp_ent</span> <span class="o">=</span> <span class="n">LitPop</span><span class="p">()</span>
        <span class="n">lp_ent</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lp_ent</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">lp_ent</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lp_ent</span><span class="p">[</span><span class="s1">&#39;region_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lp_ent</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> \
                    <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">iso_cntry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cntry_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">numeric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">lp_ent</span><span class="p">[</span><span class="s1">&#39;region_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lp_ent</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> \
                    <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">iso_cntry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_country</span><span class="p">)</span><span class="o">.</span><span class="n">numeric</span><span class="p">)</span>  
        <span class="n">lp_ent</span><span class="p">[</span><span class="n">INDICATOR_IF</span> <span class="o">+</span> <span class="n">DEF_HAZ_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lp_ent</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lp_ent</span>

    <span class="k">def</span> <span class="nf">_append_additional_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cntries_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add country information in dictionary attribute country_data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cntries_info (dict): country ISO3, name and shape</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ISO3&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">cntry_iso3</span><span class="p">,</span> <span class="n">cntry_info</span> <span class="ow">in</span> <span class="n">cntries_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">country_data</span><span class="p">[</span><span class="s1">&#39;ISO3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cntry_iso3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">country_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cntry_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">country_data</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cntry_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<div class="viewcode-block" id="LitPop.plot_log"><a class="viewcode-back" href="../../../../climada/climada.entity.exposures.html#climada.entity.exposures.litpop.LitPop.plot_log">[docs]</a>    <span class="k">def</span> <span class="nf">plot_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin1_plot</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plots the LitPop data with the color scale reprenting the values</span>
<span class="sd">            in a logarithmic scale.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            admin1_plot (boolean): whether admin1 borders should be plotted.</span>
<span class="sd">                Default=1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO: plot subplots for the different countries instead of one global</span>
        <span class="c1">#one. Countries can be identified by their region id, hence this</span>
        <span class="c1">#can be implemented</span>
        <span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="c1">#            countr_shape = _get_country_shape(country_iso, 0)</span>
            <span class="n">countr_bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>\
                                    <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>\
                                    <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>\
                                    <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>\
                   <span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">countr_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>\
                   <span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>\
                   <span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">countr_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>\
                   <span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">countr_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>\
                        <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>\
                        <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">())</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Logarithmic scale LitPop value&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;country_data&#39;</span><span class="p">)</span> <span class="ow">and</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">country_data</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">shp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">country_data</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]):</span>
                    <span class="n">_plot_shape_to_plot</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">admin1_plot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">_plot_admin1_shapes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">country_data</span><span class="p">[</span><span class="s1">&#39;ISO3&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>\
                                            <span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>

<span class="k">def</span> <span class="nf">_get_litpop_box</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">return_coords</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> \
                    <span class="n">reference_year</span><span class="o">=</span><span class="mi">2016</span><span class="p">,</span> <span class="n">exponents</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    PURPOSE:</span>
<span class="sd">        A function which retrieves and calculates the LitPop data within a</span>
<span class="sd">        certain bounding box for a given resolution.</span>
<span class="sd">    INPUTS:</span>
<span class="sd">        cut_bbox (1x4 array-like): Bounding box (ESRI type) of interest.</span>
<span class="sd">            The layout of the bounding box corresponds to the bounding box of</span>
<span class="sd">            the ESRI shape files and is as follows:</span>
<span class="sd">            [minimum longitude, minimum latitude, maximum longitude,</span>
<span class="sd">                 maxmimum latitude]</span>
<span class="sd">        resolution (scalar): resolution in arc-seconds</span>
<span class="sd">        reference_year (int): reference year, population available at:</span>
<span class="sd">            2000, 2005, 2010, 2015 (default), 2020</span>
<span class="sd">        exponents (list of two integers, default = [1, 1]) defining power with</span>
<span class="sd">            which lit (nightlights) and pop (gpw) go into LitPop.</span>
<span class="sd">            To get nightlights^3 alone: [3, 0].</span>
<span class="sd">            To use population count alone: [0, 1].</span>
<span class="sd">    OUTPUT (either one of these lines, depending on option return_coords):</span>
<span class="sd">        litpop_data (pandas SparseArray): A pandas SparseArray containing the</span>
<span class="sd">            raw, unnormalised LitPop data.</span>
<span class="sd">        OR</span>
<span class="sd">        litpop_data, lon, lat (tuple): if return_coords=1 a tuple in the</span>
<span class="sd">            form (lon, lat) with the coordinates falling into the cut_bbox are</span>
<span class="sd">            return along with the litpop_data (see above).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">nightlights</span> <span class="o">=</span> <span class="n">_get_box_blackmarble</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">reference_year</span><span class="o">=</span><span class="n">reference_year</span><span class="p">,</span> \
                                    <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">return_coords</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gpw</span> <span class="o">=</span> <span class="n">gpw_import</span><span class="o">.</span><span class="n">get_box_gpw</span><span class="p">(</span><span class="n">cut_bbox</span><span class="o">=</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>\
                                  <span class="n">return_coords</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reference_year</span><span class="o">=</span><span class="n">reference_year</span><span class="p">)</span>
    <span class="n">bm_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nightlights</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># Lit = Lit + 1 if Population is included, c.f. int(exponents[1]&gt;0):</span>
    <span class="n">bm_temp</span><span class="p">[</span><span class="n">nightlights</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nightlights</span><span class="o">.</span><span class="n">sp_values</span><span class="p">,</span> \
           <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">exponents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">nightlights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">bm_temp</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">exponents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">bm_temp</span>

    <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">_LitPop_multiply</span><span class="p">(</span><span class="n">nightlights</span><span class="p">,</span> <span class="n">gpw</span><span class="p">,</span> <span class="n">exponents</span><span class="o">=</span><span class="n">exponents</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_coords</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">_litpop_box2coords</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">litpop_data</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>
    <span class="k">return</span> <span class="n">litpop_data</span>
<span class="k">def</span> <span class="nf">_LitPop_multiply</span><span class="p">(</span><span class="n">nightlights</span><span class="p">,</span> <span class="n">gpw</span><span class="p">,</span> <span class="n">exponents</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    PURPOSE:</span>
<span class="sd">        Pixel-wise multiplication of lit (nightlights^exponents[0]) and pop</span>
<span class="sd">        (gpw^exponents[1]) to compute LitPop.</span>
<span class="sd">        Both factors are included to the power of lit_exp / pop_exp to</span>
<span class="sd">        change their weight.</span>
<span class="sd">    INPUTS:</span>
<span class="sd">        nightlights (dataframe): gridded nightlights data</span>
<span class="sd">        gpw (dataframe): gridded population data</span>
<span class="sd">        exponents (list of two integers): exponents for nightlights and</span>
<span class="sd">            population data, default = [1, 1]</span>
<span class="sd">    OUTPUT:</span>
<span class="sd">        litpop_data (dataframe): gridded resulting LitPop</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">nightlights</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="n">exponents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                            <span class="n">gpw</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="n">exponents</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>\
                                            <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">litpop_data</span>

<span class="k">def</span> <span class="nf">_litpop_box2coords</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">point_format</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    PURPOSE:</span>
<span class="sd">        A function which calculates coordinates arrays explicitly from a</span>
<span class="sd">        bounding box for a given resolution</span>
<span class="sd">    INPUTS:</span>
<span class="sd">        box (1x4 array-like): Bounding box (ESRI type) of coordinates to be</span>
<span class="sd">            delivered.</span>
<span class="sd">            the layout of the bounding box corresponds to the bounding box of</span>
<span class="sd">            the ESRI shape files and is as follows:</span>
<span class="sd">            [minimum longitude, minimum latitude, maximum longitude,</span>
<span class="sd">                 maxmimum latitude]</span>
<span class="sd">        resolution (scalar): resolution in arc-seconds</span>
<span class="sd">    OUTPUT (either one of these lines, depending on point_format):</span>
<span class="sd">        lon, lat (tuple of arrays): if point_format =0 (default) is selected</span>
<span class="sd">            a separate array for the longitude and latitude of each pixel in</span>
<span class="sd">            the bounding box is returned.</span>
<span class="sd">        coordiates (array): if point_format =1 is selected a tuple entry of</span>
<span class="sd">            the form (lon, lat) for each point is returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">deg_per_pix</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">min_col</span><span class="p">,</span> <span class="n">min_row</span><span class="p">,</span> <span class="n">max_col</span><span class="p">,</span> <span class="n">max_row</span> <span class="o">=</span>\
        <span class="n">_litpop_coords_in_glb_grid</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">max_row</span><span class="o">-</span><span class="n">min_row</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>\
                                 <span class="o">*</span><span class="p">((</span><span class="o">-</span><span class="mi">180</span><span class="o">+</span><span class="p">(</span><span class="n">deg_per_pix</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">l_i</span><span class="o">*</span><span class="n">deg_per_pix</span><span class="p">)</span>\
                                 <span class="k">for</span> <span class="n">l_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_col</span><span class="p">,</span> <span class="p">(</span><span class="n">max_col</span><span class="o">+</span><span class="mi">1</span><span class="p">))]))</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([((</span><span class="mi">90</span><span class="o">-</span><span class="p">(</span><span class="n">deg_per_pix</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">l_j</span><span class="o">*</span><span class="n">deg_per_pix</span><span class="p">))</span>\
                         <span class="k">for</span> <span class="n">l_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_row</span><span class="p">,</span> <span class="p">(</span><span class="n">max_row</span><span class="o">+</span><span class="mi">1</span><span class="p">))]</span>\
                        <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">max_col</span><span class="o">-</span><span class="n">min_col</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">max_row</span><span class="o">-</span><span class="n">min_row</span><span class="o">+</span><span class="mi">1</span><span class="p">)))))</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">point_format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">([(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>

<span class="k">def</span> <span class="nf">_litpop_coords_in_glb_grid</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    PURPOSE:</span>
<span class="sd">        Function which calculates the coordinates from geographic to</span>
<span class="sd">    a cartesian coordinate system, where the NE-most point is 0,0.</span>
<span class="sd">    INPUTS:</span>
<span class="sd">        box (1x4 array-like): Bounding box (ESRI type) of coordinates to be</span>
<span class="sd">            delivered.</span>
<span class="sd">            the layout of the bounding box corresponds to the bounding box of</span>
<span class="sd">            the ESRI shape files and is as follows:</span>
<span class="sd">            [minimum longitude, minimum latitude, maximum longitude,</span>
<span class="sd">                 maxmimum latitude]</span>
<span class="sd">        resolution (scalar): resolution in arc-seconds</span>
<span class="sd">    OUTPUTS:</span>
<span class="sd">        mincol, minrow, maxcol, maxrow (array): row and col numbers which</span>
<span class="sd">            define the box in the cartesian coordinate system.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">minlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">,</span> <span class="n">maxlat</span> <span class="o">=</span> <span class="n">box</span>
    <span class="n">deg_per_pix</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span> <span class="o">=</span> <span class="n">minlon</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">),</span> <span class="n">maxlon</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">)</span>
    <span class="n">minlat</span><span class="p">,</span> <span class="n">maxlat</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">minlat</span><span class="o">-</span><span class="p">(</span><span class="mi">90</span><span class="p">)),</span> <span class="o">-</span><span class="p">(</span><span class="n">maxlat</span><span class="o">-</span><span class="p">(</span><span class="mi">90</span><span class="p">))</span>
    <span class="n">lon_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">maxlon</span><span class="o">-</span><span class="n">minlon</span><span class="p">)</span><span class="o">/</span><span class="n">deg_per_pix</span><span class="p">)</span>
    <span class="n">lat_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">maxlat</span><span class="o">-</span><span class="n">minlat</span><span class="p">)</span><span class="o">/</span><span class="n">deg_per_pix</span><span class="p">)</span>
    <span class="n">mincol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">minlon</span><span class="o">//</span><span class="n">deg_per_pix</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">maxcol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">mincol</span> <span class="o">+</span> <span class="n">lon_dist</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mincol</span><span class="p">))</span>
    <span class="n">minrow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">maxlat</span><span class="o">//</span><span class="n">deg_per_pix</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">maxrow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">minrow</span> <span class="o">+</span> <span class="n">lat_dist</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minrow</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">mincol</span><span class="p">,</span> <span class="n">minrow</span><span class="p">,</span> <span class="n">maxcol</span><span class="p">,</span> <span class="n">maxrow</span><span class="p">))</span>

<span class="sd">&quot;&quot;&quot;def _litpop_convert_coords(box, resolution):</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    PURPOSE:</span>
<span class="sd">        A function which fits coordinates to global LitPop grid. Main purpose</span>
<span class="sd">        is to keep track of coordinates cut in reading BM and GPW without</span>
<span class="sd">        having to store pixel-based coordinates.</span>
<span class="sd">    INPUTS:</span>
<span class="sd">        box (1x4 array-like): Bounding box (ESRI type) of coordinates to be</span>
<span class="sd">            delivered. the layout of the bounding box corresponds to the</span>
<span class="sd">            bounding box of the ESRI shape files and is as follows:</span>
<span class="sd">                [minimum longitude, minimum latitude, maximum longitude,</span>
<span class="sd">                 maxmimum latitude]</span>
<span class="sd">        resolution (scalar): resolution in arc-seconds</span>
<span class="sd">    OUTPUT:</span>
<span class="sd">        box (1x4 array-like): bounding box with coordinates adjusted to global</span>
<span class="sd">            LitPop grid.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    minlon, maxlon = box[0], box[2]</span>
<span class="sd">    minlat, maxlat = box[1], box[3]</span>
<span class="sd">    deg_per_pix = 1/(3600/resolution)</span>
<span class="sd">    min_col, max_col = int(max(minlon//deg_per_pix, -180*(1/deg_per_pix))),\</span>
<span class="sd">        int(min(maxlon//deg_per_pix, (180-(deg_per_pix/2))*(1/deg_per_pix)))</span>
<span class="sd">    min_row, max_row = int(max(minlat//deg_per_pix, -90*(1/deg_per_pix))),\</span>
<span class="sd">        int(min(maxlat//deg_per_pix, (90-(deg_per_pix/2))*(1/deg_per_pix)))</span>
<span class="sd">    box = np.array((min_col*deg_per_pix+(deg_per_pix/2), min_row*deg_per_pix\</span>
<span class="sd">                    +(deg_per_pix/2), max_col*deg_per_pix\</span>
<span class="sd">                    +(deg_per_pix/2), max_row*deg_per_pix+(deg_per_pix/2)))</span>
<span class="sd">    return box</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">_get_country_shape</span><span class="p">(</span><span class="n">country_iso</span><span class="p">,</span> <span class="n">only_geo</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Retrieves the shape file or coordinate information of a country.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        country_iso (str): country code of country to get</span>
<span class="sd">        only_geo (boolean): Determines the output mode (default =0):</span>
<span class="sd">            if =0: returns the entire shape file of the country</span>
<span class="sd">            if =1: returns a tuple of values: bbox, lat, lon (see below)</span>

<span class="sd">    Returns:</span>
<span class="sd">        if only_geo = 0 (default):</span>
<span class="sd">            The shape of type shapefile._Shape</span>
<span class="sd">        if only_geo = 1</span>
<span class="sd">            bbox, lat, lon (tuple of size 3)</span>
<span class="sd">                bbox is a 1x4 vector of the bounding box of the country (array)</span>
<span class="sd">                lat is a mx1 vector of the latitudinal values of the vertices</span>
<span class="sd">                    of the shape (array)</span>
<span class="sd">                lon is a mx1 vector of the longitudinal values of the vertices</span>
<span class="sd">                    of the shape (array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">country_iso</span> <span class="o">=</span> <span class="n">country_iso</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
                                    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_0_countries&#39;</span><span class="p">)</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">country_iso</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field_num</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">::]):</span>
            <span class="c1"># Skip first (index zero) field, because it is DeletionFlag</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ADM0_A3&#39;</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field_num</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">::]):</span>
            <span class="c1"># Skip first (index zero) field, because it is DeletionFlag</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ADMIN&#39;</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">del</span> <span class="n">field</span>
    <span class="k">for</span> <span class="n">rec_i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">records</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="n">field_num</span><span class="p">]</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span> <span class="o">==</span> <span class="n">country_iso</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">only_geo</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">shp</span><span class="o">.</span><span class="n">shapes</span><span class="p">()[</span><span class="n">rec_i</span><span class="p">]</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">shapes</span><span class="p">()[</span><span class="n">rec_i</span><span class="p">]</span><span class="o">.</span><span class="n">bbox</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">shapes</span><span class="p">()[</span><span class="n">rec_i</span><span class="p">]</span><span class="o">.</span><span class="n">points</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points</span><span class="p">])</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span>

<span class="k">def</span> <span class="nf">_match_target_res</span><span class="p">(</span><span class="n">target_res</span><span class="o">=</span><span class="s1">&#39;NA&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks whether the resolution is compatible with the &quot;legacy&quot;</span>
<span class="sd">        resolutions used in Matlab Climada and produces a warning message</span>
<span class="sd">        if not.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            target_res (scalar): Resolution in arc seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">3600</span><span class="p">]</span>
    <span class="n">out_res</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">res_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">target_res</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">out_res</span> <span class="o">!=</span> <span class="n">target_res</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Not one of the legacy resoultions selected. Consider </span><span class="se">\</span>
<span class="s1">                       adjusting it to </span><span class="si">%s</span><span class="s1"> arc-sec.&#39;</span><span class="p">,</span> <span class="n">out_res</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_shape_cutter</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">opt_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks whether given coordinates are within a shape or not. Can also</span>
<span class="sd">        check if a shape possesses enclaves and cuts them out accordingly.</span>
<span class="sd">        If no coordinates are supplied, all coordinates in the bounding box</span>
<span class="sd">        of the shape under the given resolution are checked.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        shape (_shape): shape file to check</span>
<span class="sd">    Optional:</span>
<span class="sd">        opt_args (keyword arguments):</span>
<span class="sd">            resolution (scalar): resolution of the points to be checked in</span>
<span class="sd">                arcsec. Required if the points need to be created first.</span>
<span class="sd">                Defautl = 30.</span>
<span class="sd">            check_enclaves (boolean): If activated, enclaves get detected and</span>
<span class="sd">                cut out from shapes. Default = 1.</span>
<span class="sd">            check_plot (boolean): If activated, a plot with the shap and the</span>
<span class="sd">                mask is shown. Default = 0.</span>
<span class="sd">            shape_format (str, tuple): colour of the shape if it is plotted.</span>
<span class="sd">                Takes any colour format which is recognised by matplotlib.</span>
<span class="sd">            enclave_format (str, tuple): colour of the enclaves if it they are</span>
<span class="sd">                plotted. Takes any colour format which is recognised by</span>
<span class="sd">                matplotlib.</span>
<span class="sd">            return_mask (boolean): If activated, the mask is also returned</span>
<span class="sd">            points2check (list): a list of points in tuple formaat (lon, lat)</span>
<span class="sd">                for which should be checked whether they are inside the shape.</span>
<span class="sd">                if no points are delivered, the points are created for the</span>
<span class="sd">                bounding box of the shape.</span>
<span class="sd">            point_format (boolean): If activated the points get returned as</span>
<span class="sd">                a list in tuple format (lon, lat), otherwise, lon and lat</span>
<span class="sd">                get returned separately.</span>

<span class="sd">    Returns (depending on the chosen options):</span>
<span class="sd">        lon (list): list of longitudinal coordinate data of points inside shape</span>
<span class="sd">            (returned if points_format = 0)</span>
<span class="sd">        lat (list): list of latitudianl coordinate data of points inside shape</span>
<span class="sd">            (returned if points_format = 0)</span>
<span class="sd">        incl_coords (list): list of tuples of formate (lon, lat) of points</span>
<span class="sd">            inside shape (returned if points_format=1)</span>
<span class="sd">        enclave_paths (list): list of detected enclave paths</span>
<span class="sd">        mask (pandas SparseArray): SparseArray which =1 where is point is</span>
<span class="sd">            inside shape and zero otherwise. (only returned if return_mask=1)</span>
<span class="sd">        if only_geo = 0 (default):</span>
<span class="sd">            The shape of type shapefile._Shape</span>
<span class="sd">        if only_geo = 1</span>
<span class="sd">            bbox, lat, lon (tuple of size 3)</span>
<span class="sd">                bbox is a 1x4 vector of the bounding box of the country (array)</span>
<span class="sd">                lat is a mx1 vector of the latitudinal values of the vertices</span>
<span class="sd">                    of the shape (array)</span>
<span class="sd">                lon is a mx1 vector of the longitudinal values of the vertices</span>
<span class="sd">                    of the shape (array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">path</span>
    <span class="n">curr_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">check_enclaves</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_enclaves&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">check_plot</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_plot&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">return_mask</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_mask&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check_plot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shape_format</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shape_format&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>
        <span class="n">enclave_format</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enclave_format&#39;</span><span class="p">,</span> <span class="n">shape_format</span><span class="p">)</span>
    <span class="n">points2check</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;points2check&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">point_format</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;point_format&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;parts&#39;</span><span class="p">)):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Not a valid shape. Please make sure, the shapefile is </span><span class="se">\</span>
<span class="s1">                     of type from package &quot;shapefile&quot;.&#39;</span><span class="p">)</span>
    <span class="n">sub_shapes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">all_coords_shape</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">points</span><span class="p">]</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Extracting subshapes and detecting enclaves...&#39;</span><span class="p">)</span>
    <span class="n">sub_shape_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">enclave_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">add2enclave</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">sub_shapes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sub_shapes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">sub_shapes</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">check_enclaves</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">temp_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">all_coords_shape</span><span class="p">[</span><span class="n">shape</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">end_idx</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_shape_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">contains_point</span><span class="p">(</span><span class="n">temp_path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> \
                    <span class="nb">len</span><span class="p">(</span><span class="n">temp_path</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> \
                    <span class="n">val</span><span class="o">.</span><span class="n">contains_point</span><span class="p">(</span><span class="n">temp_path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span>\
                    <span class="n">val</span><span class="o">.</span><span class="n">contains_point</span><span class="p">(</span><span class="n">temp_path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">add2enclave</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">add2enclave</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">enclave_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                    <span class="n">temp_path</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">add2enclave</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sub_shape_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                    <span class="n">temp_path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_shape_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">all_coords_shape</span>\
                                            <span class="p">[</span><span class="n">shape</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">end_idx</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">check_enclaves</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Detected subshapes: </span><span class="si">%s</span><span class="s1">, of which subshapes: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>\
                         <span class="nb">str</span><span class="p">(</span><span class="n">sub_shapes</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enclave_paths</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Detected subshapes: </span><span class="si">%s</span><span class="s1">. Enclave checking disabled&#39;</span><span class="p">,</span>\
                         <span class="nb">str</span><span class="p">(</span><span class="n">sub_shapes</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sub_shape_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">all_coords_shape</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">all_coords_shape</span>
    <span class="n">incl_coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_shape_path</span><span class="p">):</span>
        <span class="n">add_points</span> <span class="o">=</span> <span class="n">_mask_from_path</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">add_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">[</span><span class="n">incl_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">add_points</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">add_points</span>
    <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check_enclaves</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enclave_paths</span><span class="p">:</span>
        <span class="n">excl_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># LOGGER.debug(&#39;Removing enclaves...&#39;)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">enclave_paths</span><span class="p">):</span>
            <span class="n">temp_excl_points</span> <span class="o">=</span> <span class="n">_mask_from_path</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_excl_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">[</span><span class="n">excl_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">temp_excl_points</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">temp_excl_points</span>
        <span class="n">excl_coords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">excl_coords</span><span class="p">)</span>
        <span class="n">incl_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">incl_coords</span> <span class="k">if</span> <span class="n">point</span> <span class="ow">not</span>\
                       <span class="ow">in</span> <span class="n">excl_coords</span><span class="p">]</span>
    <span class="c1"># LOGGER.debug(&#39;Successfully isolated coordinates from shape&#39;)</span>
    <span class="n">total_bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">points</span><span class="p">]),</span>\
      <span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">points</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">points</span><span class="p">),</span>\
      <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">points</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">points2check</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="n">_litpop_box2coords</span><span class="p">(</span><span class="n">total_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="n">points2check</span>
        <span class="k">del</span> <span class="n">points2check</span>
    <span class="n">incl_coords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">incl_coords</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">lil</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_coords</span><span class="p">),)))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_coords</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">incl_coords</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span>\
                          <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">all_coords</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span>\
                     <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">check_plot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">_plot_shape_to_plot</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">shape_format</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_enclaves</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enclave_paths</span><span class="p">:</span>
            <span class="n">_plot_paths_to_plot</span><span class="p">(</span><span class="n">enclave_paths</span><span class="p">,</span> <span class="n">enclave_format</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">point_format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="c1">#            LOGGER.debug(&#39;Cutting the shape took %s s&#39;,\</span>
<span class="c1">#                         str(round(time.time()-curr_time, 2)))</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">),</span> <span class="n">enclave_paths</span><span class="p">,</span> <span class="n">mask</span>
<span class="c1">#        LOGGER.debug(&#39;Cutting the shape took %s s&#39;,\</span>
<span class="c1">#                     str(round(time.time()-curr_time, 2)))</span>
        <span class="k">return</span> <span class="n">incl_coords</span><span class="p">,</span> <span class="n">enclave_paths</span>

<span class="c1">#    LOGGER.debug(&#39;Cutting the shape took %s s&#39;,\</span>
<span class="c1">#                 str(round(time.time()-curr_time, 2)))</span>
    <span class="k">if</span> <span class="n">return_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">enclave_paths</span><span class="p">,</span> <span class="n">mask</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">incl_coords</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">incl_coords</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">enclave_paths</span>

<span class="k">def</span> <span class="nf">_mask_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">return_points</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_mask</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">curr_bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">]),</span> <span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span>\
                          <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>\
                          <span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">])))</span>
    <span class="n">curr_points2check</span> <span class="o">=</span> <span class="n">_litpop_box2coords</span><span class="p">(</span><span class="n">curr_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">curr_bbox</span>
    <span class="k">if</span> <span class="n">curr_points2check</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="n">curr_points2check</span><span class="p">),</span>\
                               <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">points_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">curr_points2check</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span>\
                 <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">temp_mask</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">return_points</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">points_in</span><span class="p">,</span> <span class="n">temp_mask</span>
        <span class="k">return</span> <span class="n">points_in</span>

    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points_in</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points_in</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">temp_mask</span>
    <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>

<span class="k">def</span> <span class="nf">_mask_from_shape</span><span class="p">(</span><span class="n">check_shape</span><span class="p">,</span> <span class="o">**</span><span class="n">opt_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; creates a mask from a shape assigning value 1 to points inside and 0</span>
<span class="sd">        otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        check_shape (_Shape): shape file to check</span>
<span class="sd">    Optional:</span>
<span class="sd">        opt_args (keyword arguments):</span>
<span class="sd">            resolution (scalar): resolution of the points to be checked in</span>
<span class="sd">                arcsec. Required if the points need to be created first.</span>
<span class="sd">                Defautl = 30.</span>
<span class="sd">            check_enclaves (boolean): If activated, enclaves get detected and</span>
<span class="sd">                cut out from shapes. Default = 1.</span>
<span class="sd">            check_plot (boolean): If activated, a plot with the shap and the</span>
<span class="sd">                mask is shown. Default = 0.</span>
<span class="sd">            shape_format (str, tuple): colour of the shape if it is plotted.</span>
<span class="sd">                Takes any colour format which is recognised by matplotlib.</span>
<span class="sd">            enclave_format (str, tuple): colour of the enclaves if it they are</span>
<span class="sd">                plotted. Takes any colour format which is recognised by</span>
<span class="sd">                matplotlib.</span>
<span class="sd">            return_mask (boolean): If activated, the mask is also returned</span>
<span class="sd">            points2check (list): a list of points in tuple formaat (lon, lat)</span>
<span class="sd">                for which should be checked whether they are inside the shape.</span>
<span class="sd">                if no points are delivered, the points are created for the</span>
<span class="sd">                bounding box of the shape.</span>
<span class="sd">            point_format (boolean): If activated the points get returned as</span>
<span class="sd">                a list in tuple format (lon, lat), otherwise, lon and lat</span>
<span class="sd">                get returned separately.</span>

<span class="sd">    Returns (depending on the chosen options):</span>
<span class="sd">        lon (list): list of longitudinal coordinate data of points inside shape</span>
<span class="sd">            (returned if points_format = 0)</span>
<span class="sd">        lat (list): list of latitudianl coordinate data of points inside shape</span>
<span class="sd">            (returned if points_format = 0)</span>
<span class="sd">        incl_coords (list): list of tuples of formate (lon, lat) of points</span>
<span class="sd">            inside shape (returned if points_format=1)</span>
<span class="sd">        enclave_paths (list): list of detected enclave paths</span>
<span class="sd">        mask (pandas SparseArray): SparseArray which =1 where is point is</span>
<span class="sd">            inside shape and zero otherwise. (only returned if return_mask=1)</span>
<span class="sd">        if only_geo = 0 (default):</span>
<span class="sd">            The shape of type shapefile._Shape</span>
<span class="sd">        if only_geo = 1</span>
<span class="sd">            bbox, lat, lon (tuple of size 3)</span>
<span class="sd">                bbox is a 1x4 vector of the bounding box of the country (array)</span>
<span class="sd">                lat is a mx1 vector of the latitudinal values of the vertices</span>
<span class="sd">                    of the shape (array)</span>
<span class="sd">                lon is a mx1 vector of the longitudinal values of the vertices</span>
<span class="sd">                    of the shape (array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">path</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">check_enclaves</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_enclaves&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">points2check</span> <span class="o">=</span> <span class="n">opt_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;points2check&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">check_shape</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">))</span> <span class="ow">or</span>\
                            <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">check_shape</span><span class="p">,</span> <span class="s1">&#39;parts&#39;</span><span class="p">)):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Not a valid shape. Please make sure, the shapefile is </span><span class="se">\</span>
<span class="s1">                     of type from package &quot;shapefile&quot;.&#39;</span><span class="p">)</span>
    <span class="n">sub_shapes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_shape</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">all_coords_shape</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">check_shape</span><span class="o">.</span><span class="n">points</span><span class="p">]</span>
    <span class="c1"># LOGGER.debug(&#39;Extracting subshapes and detecting enclaves...&#39;)</span>
    <span class="n">sub_shape_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">enclave_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">add2enclave</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">sub_shapes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sub_shapes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">sub_shapes</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_shape</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">check_shape</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">check_enclaves</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">temp_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">all_coords_shape</span>\
                                      <span class="p">[</span><span class="n">check_shape</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">end_idx</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_shape_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">contains_point</span><span class="p">(</span><span class="n">temp_path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> \
                        <span class="nb">len</span><span class="p">(</span><span class="n">temp_path</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> \
                        <span class="n">val</span><span class="o">.</span><span class="n">contains_point</span><span class="p">(</span><span class="n">temp_path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span>\
                        <span class="n">val</span><span class="o">.</span><span class="n">contains_point</span><span class="p">(</span><span class="n">temp_path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="c1">#Only check if the first three vertices of the new shape</span>
                    <span class="c1"># is in any of the old shapes for speed</span>
                        <span class="n">add2enclave</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">add2enclave</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">enclave_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                    <span class="n">temp_path</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">add2enclave</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sub_shape_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                    <span class="n">temp_path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_shape_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">all_coords_shape</span>\
                                      <span class="p">[</span><span class="n">check_shape</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">end_idx</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">check_enclaves</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Detected subshapes: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sub_shapes</span><span class="p">))</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;of which detected enclaves: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enclave_paths</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detected subshapes: </span><span class="si">%s</span><span class="s1">. Enclave checking disabled.&#39;</span><span class="p">,</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="n">sub_shapes</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sub_shape_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">all_coords_shape</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">all_coords_shape</span>
    <span class="n">incl_coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_shape_path</span><span class="p">):</span>
        <span class="n">add_points</span> <span class="o">=</span> <span class="n">_mask_from_path</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">add_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">[</span><span class="n">incl_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">add_points</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">add_points</span>
    <span class="c1"># stdout.write(&#39;\n&#39;)</span>
    <span class="k">if</span> <span class="n">check_enclaves</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enclave_paths</span><span class="p">:</span>
        <span class="n">excl_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removing enclaves...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">enclave_paths</span><span class="p">):</span>
            <span class="n">temp_excl_points</span> <span class="o">=</span> <span class="n">_mask_from_path</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_excl_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">[</span><span class="n">excl_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">temp_excl_points</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">temp_excl_points</span>
        <span class="n">excl_coords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">excl_coords</span><span class="p">)</span>
        <span class="n">incl_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">incl_coords</span> <span class="k">if</span> <span class="n">point</span> <span class="ow">not</span> <span class="ow">in</span>\
                       <span class="n">excl_coords</span><span class="p">]</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Successfully isolated coordinates from shape&#39;</span><span class="p">)</span>
    <span class="n">total_bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">check_shape</span><span class="o">.</span><span class="n">points</span><span class="p">]),</span>\
      <span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">check_shape</span><span class="o">.</span><span class="n">points</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span>\
             <span class="ow">in</span> <span class="n">check_shape</span><span class="o">.</span><span class="n">points</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">check_shape</span><span class="o">.</span><span class="n">points</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">points2check</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="n">_litpop_box2coords</span><span class="p">(</span><span class="n">total_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="n">points2check</span>
        <span class="k">del</span> <span class="n">points2check</span>
    <span class="n">incl_coords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">incl_coords</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">lil</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_coords</span><span class="p">),)))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_coords</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">incl_coords</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span>\
                          <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool_&#39;</span><span class="p">)</span>
<span class="c1">#    plt.figure()</span>
<span class="c1">#    l1, l2 = zip(*[x for n, x in enumerate(all_coords) if mask.values[n]==1])</span>
<span class="c1">#    plt.scatter(l1, l2)</span>
<span class="c1">#    _plot_shape_to_plot(check_shape)</span>
    <span class="k">return</span> <span class="n">mask</span>

<span class="k">def</span> <span class="nf">_get_country_info</span><span class="p">(</span><span class="n">iso3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get country ISO alpha_3, country id (defined as country appearance</span>
<span class="sd">    order in natural earth shape file) and country&#39;s geometry.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        countries (list or dict): list of country names (admin0) or dict</span>
<span class="sd">            with key = admin0 name and value = [admin1 names]</span>
<span class="sd">        shp_file (cartopy.io.shapereader.Reader): shape file</span>

<span class="sd">    Returns:</span>
<span class="sd">        cntry_info (dict): key = ISO alpha_3 country, value = [country id,</span>
<span class="sd">            country name, country geometry]</span>

<span class="sd">    Retrieves the shape file or coordinate information of a country.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        country_iso (str): country code of country to get</span>
<span class="sd">        only_geo (boolean): Determines the output mode (default =0):</span>
<span class="sd">            if =0: returns the entire shape file of the country</span>
<span class="sd">            if =1: returns a tuple of values: bbox, lat, lon (see below)</span>

<span class="sd">    Returns:</span>
<span class="sd">        if only_geo = 0 (default):</span>
<span class="sd">            The shape of type shapefile._Shape</span>
<span class="sd">        if only_geo = 1</span>
<span class="sd">            bbox, lat, lon (tuple of size 3)</span>
<span class="sd">                bbox is a 1x4 vector of the bounding box of the country (array)</span>
<span class="sd">                lat is a mx1 vector of the latitudinal values of the vertices of the shape (array)</span>
<span class="sd">                lon is a mx1 vector of the longitudinal values of the vertices of the shape (array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
                                    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_0_countries&#39;</span><span class="p">)</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field_num</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">::]):</span>
        <span class="c1"># Skip first (index zero) field, because it is DeletionFlag</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ADM0_A3&#39;</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">del</span> <span class="n">field</span>
    <span class="k">for</span> <span class="n">field_num2</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">::]):</span>
        <span class="c1"># Skip first (index zero) field, because it is DeletionFlag</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ADMIN&#39;</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">del</span> <span class="n">field</span>
    <span class="k">for</span> <span class="n">rec_i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">records</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="n">field_num</span><span class="p">]</span> <span class="o">==</span> <span class="n">iso3</span><span class="p">:</span>
            <span class="n">country_shp</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">shapes</span><span class="p">()[</span><span class="n">rec_i</span><span class="p">]</span>
            <span class="n">country_name</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="n">field_num2</span><span class="p">]</span>
            <span class="k">break</span>

    <span class="n">num_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">iso3</span> <span class="k">for</span> <span class="n">iso3</span> <span class="ow">in</span> <span class="n">wb</span><span class="o">.</span><span class="n">country_codes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iso3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>

    <span class="n">admin1_file</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
                                            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_1_states_provinces&#39;</span><span class="p">)</span>
    <span class="n">admin1_recs</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">admin1_file</span><span class="p">)</span>
    <span class="n">admin1_recs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">admin1_recs</span><span class="o">.</span><span class="n">records</span><span class="p">())</span>
    <span class="n">country_admin1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">admin1_recs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;adm0_a3&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iso3</span><span class="p">:</span>
            <span class="n">country_admin1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">iso_num</span> <span class="o">=</span> <span class="n">num_codes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">iso3</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">iso_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">num_codes</span><span class="p">)</span>
    <span class="n">cntry_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">iso_num</span><span class="p">,</span> <span class="n">country_name</span><span class="p">,</span> <span class="n">country_shp</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cntry_info</span><span class="p">,</span> <span class="n">country_admin1</span>

<span class="k">def</span> <span class="nf">_bbox_union</span><span class="p">(</span><span class="n">bbox_in</span><span class="p">):</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,))</span>
    <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bbox_in</span><span class="p">])</span>
    <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bbox_in</span><span class="p">])</span>
    <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bbox_in</span><span class="p">])</span>
    <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bbox_in</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">bbox</span>

<span class="k">def</span> <span class="nf">_get_iso3</span><span class="p">(</span><span class="n">country_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Find the ISO3 name corresponding to a country name. Can also be used</span>
<span class="sd">        to check if an ISO3 exists.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        country_name (str): the country name to be checked.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ISO3 (str): if the country name / ISO3 was found OR None (NoneType)</span>
<span class="sd">            otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">country_name</span> <span class="o">=</span> <span class="n">country_name</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
                                    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_0_countries&#39;</span><span class="p">)</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field_num</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">::]):</span>
        <span class="c1"># Skip first (index zero) field, because it is DeletionFlag</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ADM0_A3&#39;</span><span class="p">:</span>
            <span class="n">field_adm</span> <span class="o">=</span> <span class="n">field_num</span>
            <span class="k">if</span> <span class="s1">&#39;field_name&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">break</span>
        <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ADMIN&#39;</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_num</span>
            <span class="k">if</span> <span class="s1">&#39;field_adm&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">break</span>
    <span class="k">del</span> <span class="n">field</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">shp</span><span class="o">.</span><span class="n">records</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">country_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">rec</span><span class="p">[</span><span class="n">field_adm</span><span class="p">]</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span> <span class="o">==</span> <span class="n">country_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rec</span><span class="p">[</span><span class="n">field_adm</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">rec</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span> <span class="o">==</span> <span class="n">country_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rec</span><span class="p">[</span><span class="n">field_adm</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span> <span class="nf">_get_gdp2asset_factor</span><span class="p">(</span><span class="n">cntry_info</span><span class="p">,</span> <span class="n">ref_year</span><span class="p">,</span> <span class="n">shp_file</span><span class="p">,</span> <span class="n">fin_mode</span><span class="o">=</span><span class="s1">&#39;income_group&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Append factor to convert GDP to physcial asset values according to</span>
<span class="sd">        the Global Wealth Databook by the Credit Suisse Research Institute.</span>
<span class="sd">        Requires a pickled file containg a dictionary with the three letter</span>
<span class="sd">        country code as the key. The values are lists, each containg the</span>
<span class="sd">        country&#39;s name the factor for non-financial assets and the factor</span>
<span class="sd">        for financial assets (in this order).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        cntry_info (dict): key = ISO alpha_3 country, value = [country id,</span>
<span class="sd">            country name, country geometry]</span>
<span class="sd">        ref_year (int): reference year</span>
<span class="sd">        fin_mode (str): define what total country economic value</span>
<span class="sd">                is to be used as an asset base and distributed to the grid:</span>
<span class="sd">                - gdp: gross-domestic product</span>
<span class="sd">                - income_group: gdp multiplied by country&#39;s income group+1</span>
<span class="sd">                - nfw: non-financial wealth (of households only)</span>
<span class="sd">                - tw: total wealth (of households only)</span>
<span class="sd">                - pc: produced capital</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fin_mode</span> <span class="o">==</span> <span class="s1">&#39;income_group&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cntry_iso</span><span class="p">,</span> <span class="n">cntry_val</span> <span class="ow">in</span> <span class="n">cntry_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">inc_grp</span> <span class="o">=</span> <span class="n">income_group</span><span class="p">(</span><span class="n">cntry_iso</span><span class="p">,</span> <span class="n">ref_year</span><span class="p">,</span> <span class="n">shp_file</span><span class="p">)</span>
            <span class="n">cntry_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inc_grp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fin_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;gdp&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cntry_iso</span><span class="p">,</span> <span class="n">cntry_val</span> <span class="ow">in</span> <span class="n">cntry_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cntry_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fin_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;nfw&#39;</span><span class="p">,</span> <span class="s1">&#39;tw&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cntry_iso</span><span class="p">,</span> <span class="n">cntry_val</span> <span class="ow">in</span> <span class="n">cntry_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">wealthtogdp_factor</span> <span class="o">=</span> <span class="n">wealth2gdp</span><span class="p">(</span><span class="n">cntry_iso</span><span class="p">,</span> <span class="n">fin_mode</span> <span class="o">==</span> <span class="s1">&#39;nfw&#39;</span><span class="p">,</span> <span class="n">ref_year</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">wealthtogdp_factor</span><span class="p">):</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Missing factor for country </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">cntry_iso</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Factor to convert GDP to assets will be set to 1.&quot;</span><span class="p">)</span>
                <span class="n">wealthtogdp_factor</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">cntry_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wealthtogdp_factor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;invalid fin_mode&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_gsdp_read</span><span class="p">(</span><span class="n">country_iso3</span><span class="p">,</span> <span class="n">admin1_shape_data</span><span class="p">,</span>\
               <span class="n">look_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SYSTEM_DIR</span><span class="p">,</span> <span class="s1">&#39;GSDP&#39;</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39; Retrieves the GSDP data for a certain country. It requires an</span>
<span class="sd">        excel file in a subfolder &quot;GSDP&quot; in climadas data folder (or in the</span>
<span class="sd">        specified folder). The excel file should bear the name</span>
<span class="sd">        &#39;ISO3_GSDP.xlsx&#39; (or .xls), where ISO3 is the three letter country</span>
<span class="sd">        code. In the excel file, the first sheet should contain a row</span>
<span class="sd">        with the title &quot;State_Province&quot; with the name or postal code (two</span>
<span class="sd">        letters) of the admin1 unit and a row &quot;GSDP_ref&quot; with either the GDP</span>
<span class="sd">        value of the admin1 unit or its share in the national GDP.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        country_iso3 (string): three letter country code</span>
<span class="sd">        admin1_shape_data (list): list containg all admin1 shapes of the</span>
<span class="sd">            country.</span>
<span class="sd">        look_folder (string): path where to look for file</span>

<span class="sd">    Returns:</span>
<span class="sd">        out_dict (dictionary): dictionary which contains the GSDP for each</span>
<span class="sd">            admin1 unit, where the name of the admin1 unit is the key.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">_check_excel_exists</span><span class="p">(</span><span class="n">look_folder</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">country_iso3</span> <span class="o">+</span> <span class="s1">&#39;_GSDP&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">admin1_xls_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">admin1_xls_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;State_Province&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">admin1_xls_data</span> <span class="o">=</span> <span class="n">admin1_xls_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>\
                           <span class="p">{</span><span class="n">admin1_xls_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="s1">&#39;State_Province&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">admin1_xls_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GSDP_ref&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">admin1_xls_data</span> <span class="o">=</span> <span class="n">admin1_xls_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>\
                           <span class="p">{</span><span class="n">admin1_xls_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="s1">&#39;GSDP_ref&#39;</span><span class="p">})</span>
<span class="c1">#        prov = admin1_xls_data[&#39;State_Province&#39;].tolist()</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="n">nam</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">nam</span> <span class="ow">in</span>\
                           <span class="n">admin1_shape_data</span><span class="p">])</span>
        <span class="n">postals</span> <span class="o">=</span> <span class="p">[</span><span class="n">nam</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;postal&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">nam</span> <span class="ow">in</span> <span class="n">admin1_shape_data</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">subnat_shape</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">subnat_xls</span>\
                <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">admin1_xls_data</span><span class="p">[</span><span class="s1">&#39;State_Province&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">_compare_strings_nospecchars</span><span class="p">(</span><span class="n">subnat_shape</span><span class="p">,</span> <span class="n">subnat_xls</span><span class="p">):</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="n">subnat_shape</span><span class="p">]</span> <span class="o">=</span> <span class="n">admin1_xls_data</span><span class="p">[</span><span class="s1">&#39;GSDP_ref&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="c1"># Now a second loop to detect empty ones</span>
        <span class="k">for</span> <span class="n">idx1</span><span class="p">,</span> <span class="n">country_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">out_dict</span><span class="p">[</span><span class="n">country_name</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">subnat_xls</span>\
                <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">admin1_xls_data</span><span class="p">[</span><span class="s1">&#39;State_Province&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">_compare_strings_nospecchars</span><span class="p">(</span><span class="n">postals</span><span class="p">[</span><span class="n">idx1</span><span class="p">],</span> <span class="n">subnat_xls</span><span class="p">):</span>
                        <span class="n">out_dict</span><span class="p">[</span><span class="n">country_name</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="n">admin1_xls_data</span><span class="p">[</span><span class="s1">&#39;GSDP_ref&#39;</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out_dict</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No file for </span><span class="si">%s</span><span class="s1"> could be found in </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">country_iso3</span><span class="p">,</span> <span class="n">look_folder</span><span class="p">)</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No admin1 data is calculated in this case.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">_check_excel_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">xlsx_before_xls</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Checks if an Excel file with the name file_name in the folder</span>
<span class="sd">    file_path exists, checking for both xlsx and xls files.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_path (string): path where to look for file</span>
<span class="sd">        file_name (string): file name which is checked. Extension is ignored</span>
<span class="sd">        xlsx_before_xls (boolean): If set =1, xlsx files are priorised over</span>
<span class="sd">            xls files. Default=1.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">try_ext</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">xlsx_before_xls</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">try_ext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">)</span>
        <span class="n">try_ext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.xls&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">try_ext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.xls&#39;</span><span class="p">)</span>
        <span class="n">try_ext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">)</span>
    <span class="n">path_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">try_ext</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">path_name</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">path_name</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">_compare_strings_nospecchars</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compares strings while ignoring non-alphanumeric and special</span>
<span class="sd">        characters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        str1 (string): string to be compared to str2</span>
<span class="sd">        str2 (string): string to be compared to str1</span>
<span class="sd">    Returns</span>
<span class="sd">        Boolean: True if the strings are the same, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid datatype (not strings), which cannot be &#39;</span>\
                    <span class="o">+</span> <span class="s1">&#39;compared. Function will return exit and return false.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[^a-z|A-Z|0-9| ]&#39;</span><span class="p">)</span> <span class="c1">#ignore special</span>
    <span class="n">cstr1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">str1</span><span class="p">)</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
    <span class="n">cstr2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">str2</span><span class="p">)</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cstr1</span> <span class="o">==</span> <span class="n">cstr2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_plot_shape_to_plot</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="n">gray_val</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot; Plots a shape file to a pyplot.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        shp (shapefile._Shape): shapefile to be plotted</span>
<span class="sd">        gray_val: (scalar): grayscale value of color line between zero and one.</span>
<span class="sd">            A value of zero corresponds to black and one to white.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gray_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gray_val</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">x_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shp</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]])</span>
        <span class="n">y_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shp</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_arr</span><span class="p">,</span> <span class="n">y_arr</span><span class="p">,</span> <span class="n">gray_val</span><span class="p">)</span>
    <span class="n">x_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shp</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]])</span>
    <span class="n">y_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shp</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_arr</span><span class="p">,</span> <span class="n">y_arr</span><span class="p">,</span> <span class="n">gray_val</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_paths_to_plot</span><span class="p">(</span><span class="n">list_of_paths</span><span class="p">,</span> <span class="n">gray_val</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot; Plot a path or paths to a pyplot</span>

<span class="sd">    Parameters:</span>
<span class="sd">        list of paths (list): paths to be plotted</span>
<span class="sd">        gray_val: (scalar): grayscale value of color line between zero and one.</span>
<span class="sd">            A value of zero corresponds to black and one to white.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gray_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gray_val</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_paths</span><span class="p">)):</span>
        <span class="n">x_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_of_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">vertices</span><span class="p">])</span>
        <span class="n">y_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_of_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">vertices</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_arr</span><span class="p">,</span> <span class="n">y_arr</span><span class="p">,</span> <span class="n">gray_val</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_admin1_shapes</span><span class="p">(</span><span class="n">adm0_a3</span><span class="p">,</span> <span class="n">gray_val</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot; Retrieves the shape file or coordinate information of a country.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        adm0_a3 (str): iso3 country code of country to get</span>
<span class="sd">        only_geo (boolean): Determines the output mode (default =0):</span>
<span class="sd">            if =0: returns the entire shape file of the country</span>
<span class="sd">            if =1: returns a tuple of values: bbox, lat, lon (see below)</span>

<span class="sd">    Returns:</span>
<span class="sd">        if only_geo = 0 (default):</span>
<span class="sd">            The shape of type shapefile._Shape</span>
<span class="sd">        if only_geo = 1</span>
<span class="sd">            bbox, lat, lon (tuple of size 3)</span>
<span class="sd">                bbox is a 1x4 vector of the bounding box of the country (array)</span>
<span class="sd">                lat is a mx1 vector of the latitudinal values of the vertices</span>
<span class="sd">                    of the shape (array)</span>
<span class="sd">                lon is a mx1 vector of the longitudinal values of the vertices</span>
<span class="sd">                    of the shape (array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shp_file</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>\
                                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_1_states_provinces&#39;</span><span class="p">)</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">shp_file</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">shp_file</span>
    <span class="k">for</span> <span class="n">field_num</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">::]):</span>
        <span class="c1"># Skip first (index zero) field, because it is DeletionFlag</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ADM0_A3&#39;</span><span class="o">.</span><span class="n">casefold</span><span class="p">():</span>
            <span class="k">break</span>
    <span class="k">del</span> <span class="n">field</span>
    <span class="n">adm1_shapes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rec_i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">records</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="n">field_num</span><span class="p">]</span> <span class="o">==</span> <span class="n">adm0_a3</span><span class="p">:</span>
            <span class="n">adm1_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">shapes</span><span class="p">()[</span><span class="n">rec_i</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">adm1_shapes</span><span class="p">:</span>
        <span class="n">_plot_shape_to_plot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">gray_val</span><span class="o">=</span><span class="n">gray_val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_calc_admin1</span><span class="p">(</span><span class="n">curr_country</span><span class="p">,</span> <span class="n">country_info</span><span class="p">,</span> <span class="n">admin1_info</span><span class="p">,</span> <span class="n">litpop_data</span><span class="p">,</span>\
                 <span class="n">coords</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">adm1_scatter</span><span class="p">,</span> <span class="n">conserve_cntrytotal</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> \
                 <span class="n">check_plot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">masks_adm1</span><span class="o">=</span><span class="p">[],</span> <span class="n">return_data</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># TODO: if a state/province has GSDP value, but no coordinates inside,</span>
<span class="c1">#    the final total value is off (e.g. Basel Switzerland at 300 arcsec).</span>
<span class="c1">#    Potential fix: normalise the value in the end</span>
    <span class="sd">&quot;&quot;&quot; Calculates the LitPop on admin1 level for provinces/states where such</span>
<span class="sd">        information is available (i.e. GDP is distributed on a subnational</span>
<span class="sd">        instead of a national level). Requires excel files in a subfolder</span>
<span class="sd">        &quot;GSDP&quot; in climadas data folder. The excel files should contain a row</span>
<span class="sd">        with the title &quot;State_Province&quot; with the name or postal code (two</span>
<span class="sd">        letters) of the admin1 unit and a row &quot;GSDP_ref&quot; with either the GDP</span>
<span class="sd">        value or the share of the state in the national GDP.</span>
<span class="sd">        If only for certain states admin1 info is found, the rest of the</span>
<span class="sd">        country is assigned value according to the admin0 method.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        curr_country (str): country code of country to get</span>
<span class="sd">        country_info (list): a list which contains information about the</span>
<span class="sd">            country (is produced in the .set_country procedure). GDP should be</span>
<span class="sd">            stored in index 3 and the factor to convert GDP to physical asset</span>
<span class="sd">            values is stored in position index 4.</span>
<span class="sd">        admin1_info (list): a list which contains information about the admin1</span>
<span class="sd">            level of the country (is produced in the .set_country procedure).</span>
<span class="sd">            It contains Shape files among others.</span>
<span class="sd">        litpop_data (pandas SparseArray): The raw litpop_data to which the</span>
<span class="sd">            admin1 based value should be assinged.</span>
<span class="sd">        coords (list): a list containing all the coordinates of the country in</span>
<span class="sd">            the format (lon, lat)</span>
<span class="sd">        resolution (scalar): the desired resolution in arc-seconds.</span>
<span class="sd">        adm1_scatter (boolean): whether a scatter plot and correlation comparing admin0 and</span>
<span class="sd">            admin1 results should be produced.</span>
<span class="sd">        conserve_cntrytotal (boolean): if True, final LitPop is normalized with country value</span>

<span class="sd">    Returns:</span>
<span class="sd">        litpop_data (pandas SparseArray): The litpop_data the sum of which</span>
<span class="sd">            corresponds to the GDP multiplied by the GDP2Asset conversion</span>
<span class="sd">            factor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gsdp_data</span> <span class="o">=</span> <span class="n">_gsdp_read</span><span class="p">(</span><span class="n">curr_country</span><span class="p">,</span> <span class="n">admin1_info</span><span class="p">)</span>
    <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">_normalise_litpop</span><span class="p">(</span><span class="n">litpop_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gsdp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sum_vals</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gsdp_data</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">gsdp_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">value</span><span class="o">/</span><span class="n">sum_vals</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>\
                     <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gsdp_data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">gsdp_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span> <span class="c1"># standard loop if all GSDP data is available</span>
            <span class="n">temp_adm1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;adm0_LitPop_share&#39;</span><span class="p">:[],</span> <span class="s1">&#39;adm1_LitPop_share&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">idx3</span><span class="p">,</span> <span class="n">adm1_shp</span> <span class="ow">in</span>\
                <span class="nb">enumerate</span><span class="p">(</span><span class="n">admin1_info</span><span class="p">):</span>
                <span class="c1"># start_time = time.time()</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Caclulating admin1 for </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">adm1_shp</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">masks_adm1</span><span class="p">:</span>
                    <span class="n">mask_adm1</span> <span class="o">=</span> <span class="n">_mask_from_shape</span><span class="p">(</span><span class="n">adm1_shp</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span>\
                             <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>\
                             <span class="n">points2check</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
                    <span class="n">shr_adm0</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask_adm1</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shr_adm0</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">masks_adm1</span><span class="p">[</span><span class="n">idx3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
                <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;adm0_LitPop_share&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shr_adm0</span><span class="p">)</span>
                <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;adm1_LitPop_share&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">gsdp_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>\
                         <span class="p">[</span><span class="n">idx3</span><span class="p">])</span>
                <span class="c1"># LitPop in the admin1-unit is scaled by ratio of admin</span>
                <span class="k">if</span> <span class="n">shr_adm0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="n">country_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>\
                        <span class="o">*</span><span class="n">country_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
                        <span class="o">*</span><span class="n">gsdp_data</span><span class="p">[</span><span class="n">adm1_shp</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">/</span><span class="n">shr_adm0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">return_data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">masks_adm1</span><span class="p">:</span>
                        <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">([</span><span class="n">val</span><span class="o">*</span><span class="n">mult</span> <span class="k">if</span>\
                              <span class="n">mask_adm1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">val</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span>\
                              <span class="nb">enumerate</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span><span class="p">)],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">([</span><span class="n">val</span><span class="o">*</span><span class="n">mult</span> <span class="k">if</span>\
                              <span class="n">masks_adm1</span><span class="p">[</span><span class="n">idx3</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">val</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span>\
                              <span class="nb">enumerate</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span><span class="p">)],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>         
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_adm1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;adm0_LitPop_share&#39;</span><span class="p">:[],</span>\
                         <span class="s1">&#39;adm1_LitPop_share&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;LitPop_sum&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">_calc_admin0</span><span class="p">(</span><span class="n">litpop_data</span><span class="p">,</span> <span class="n">country_info</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>\
                                       <span class="n">country_info</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">sum_litpop</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">sp_values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx3</span><span class="p">,</span> <span class="n">adm1_shp</span> <span class="ow">in</span>\
                <span class="nb">enumerate</span><span class="p">(</span><span class="n">admin1_info</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">masks_adm1</span><span class="p">:</span>
                    <span class="n">mask_adm1</span> <span class="o">=</span> <span class="n">_mask_from_shape</span><span class="p">(</span><span class="n">adm1_shp</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span>\
                                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>\
                                <span class="n">points2check</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask_adm1</span> <span class="o">=</span> <span class="n">masks_adm1</span><span class="p">[</span><span class="n">idx3</span><span class="p">]</span>
                <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask_adm1</span><span class="p">)</span>
                <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;LitPop_sum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span>\
                                               <span class="p">[</span><span class="n">mask_adm1</span><span class="o">.</span><span class="n">values</span><span class="p">]))</span>
                <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;adm0_LitPop_share&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span>\
                                               <span class="p">[</span><span class="n">mask_adm1</span><span class="o">.</span><span class="n">values</span><span class="p">])</span><span class="o">/</span><span class="n">sum_litpop</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">mask_adm1</span>
            <span class="n">sum_litpop_adm1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>\
                                <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">n1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>\
                <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gsdp_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span>\
                <span class="ow">not</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">admin1_share</span> <span class="o">=</span> <span class="n">sum_litpop_adm1</span><span class="o">/</span><span class="n">sum_litpop</span>
            <span class="k">for</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span>\
                <span class="nb">enumerate</span><span class="p">(</span><span class="n">gsdp_data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calculating admin1 data for </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> \
                                 <span class="n">admin1_info</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="n">val</span><span class="o">*</span><span class="n">admin1_share</span>\
                            <span class="o">*</span><span class="p">(</span><span class="n">country_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">country_info</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>\
                            <span class="o">/</span><span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;LitPop_sum&#39;</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span>
                    <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">return_data</span><span class="p">:</span>
                        <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">([</span><span class="n">val1</span><span class="o">*</span><span class="n">mult</span> <span class="k">if</span>\
                            <span class="n">temp_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">val1</span>\
                            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val1</span> <span class="ow">in</span>\
                            <span class="nb">enumerate</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span><span class="p">)])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No admin1 data found for </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> \
                                   <span class="n">admin1_info</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Only admin0 data is calculated in this case.&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx5</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">admin1_info</span><span class="p">):</span>
                <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;adm1_LitPop_share&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">gsdp_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>\
                         <span class="p">[</span><span class="n">idx5</span><span class="p">])</span>
                <span class="c1"># LP_sum = sum(litpop_data.values)</span>
                <span class="c1"># temp_adm1[&#39;adm1_LitPop_share&#39;].append(sum(litpop_data.values\</span>
                <span class="c1">#        [temp_adm1[&#39;mask&#39;][idx5].values])/LP_sum)</span>
        <span class="k">if</span> <span class="n">adm1_scatter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pearsonr</span><span class="p">,</span> <span class="n">spearmanr</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">rmsf</span> <span class="o">=</span> <span class="n">_litpop_scatter</span><span class="p">(</span><span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;adm0_LitPop_share&#39;</span><span class="p">],</span>\
                            <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;adm1_LitPop_share&#39;</span><span class="p">],</span> <span class="n">admin1_info</span><span class="p">,</span> <span class="n">check_plot</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">return_data</span><span class="p">:</span>
        <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">_calc_admin0</span><span class="p">(</span><span class="n">litpop_data</span><span class="p">,</span> <span class="n">country_info</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>\
                                   <span class="n">country_info</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">conserve_cntrytotal</span> <span class="ow">and</span> <span class="n">return_data</span><span class="p">:</span>
        <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">_normalise_litpop</span><span class="p">(</span><span class="n">litpop_data</span><span class="p">)</span><span class="o">*</span><span class="n">country_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">country_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_data</span><span class="p">:</span>
        <span class="n">litpop_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">adm1_scatter</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">litpop_data</span><span class="p">,</span> <span class="p">[</span><span class="n">pearsonr</span><span class="p">,</span> <span class="n">spearmanr</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">rmsf</span><span class="p">],</span> \
                <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;adm0_LitPop_share&#39;</span><span class="p">],</span> <span class="n">temp_adm1</span><span class="p">[</span><span class="s1">&#39;adm1_LitPop_share&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">litpop_data</span>

<span class="k">def</span> <span class="nf">_calc_admin0</span><span class="p">(</span><span class="n">litpop_data</span><span class="p">,</span> <span class="n">total_asset_val</span><span class="p">,</span> <span class="n">gdptoasset_factor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the LitPop on a national level. The total value distributed</span>
<span class="sd">        corresponds to GDP times the factor to convert GDP to assets from</span>
<span class="sd">        the Gloabl Wealth Databook by the Credit Suisse Research Institute.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        litpop_data (pandas SparseArray): The raw litpop_data to which the</span>
<span class="sd">            admin0 based value should be assinged.</span>
<span class="sd">        total_asset_val (scalar): The total asset value of the country.</span>
<span class="sd">        gdptoasset_factor (scalar): The factor with which GDP can be converted</span>
<span class="sd">            to physical asset value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        litpop_data (pandas SparseArray): The litpop_data the sum of which</span>
<span class="sd">            corresponds to the GDP multiplied by the GDP2Asset conversion</span>
<span class="sd">            factor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">_normalise_litpop</span><span class="p">(</span><span class="n">litpop_data</span><span class="p">)</span>
    <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">*</span><span class="n">total_asset_val</span><span class="o">*</span><span class="n">gdptoasset_factor</span>
    <span class="k">return</span> <span class="n">litpop_data</span>

<span class="k">def</span> <span class="nf">_normalise_litpop</span><span class="p">(</span><span class="n">litpop_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Normailses LitPop data, such that its total sum equals to one.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        litpop_data (pandas SparseArray): The litpop_data which sjould be</span>
<span class="sd">            normalised.</span>

<span class="sd">    Returns:</span>
<span class="sd">        litpop_data (pandas SparseArray): The litpop_data the sum of which</span>
<span class="sd">            corresponds to one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">litpop_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">):</span>
        <span class="n">sum_all</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">sp_values</span><span class="p">)</span>
        <span class="n">litpop_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">litpop_data</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="n">sum_all</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;LitPop data is not of expected type (Pandas &#39;</span>\
                   <span class="o">+</span> <span class="s1">&#39;SparseArray). Operation aborted.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span>
    <span class="k">return</span> <span class="n">litpop_data</span>

<span class="k">def</span> <span class="nf">_check_bbox_country_cut_mode</span><span class="p">(</span><span class="n">country_cut_mode</span><span class="p">,</span> <span class="n">cut_bbox</span><span class="p">,</span> <span class="n">country_adm0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks whether a bounding box is valid an compatible with the chosen</span>
<span class="sd">        country cut mode.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            country_cut_mode (scalar): the chosen country cut mode.</span>
<span class="sd">            cut_bbox (4x1 array): the bounding box, ESRI style.</span>
<span class="sd">            country_adm0 (string): three letter country code.</span>

<span class="sd">        Returns:</span>
<span class="sd">            cut_bbox (4x1 array): the bounding box, corrected if neccessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">country_adm0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">country_cut_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>\
                                                    <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cut_bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">cut_bbox</span> <span class="o">=</span> <span class="n">_get_country_shape</span><span class="p">(</span><span class="n">country_adm0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Custom bounding box overwritten in chosen </span><span class="se">\</span>
<span class="s1">                                                           country cut mode.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">country_adm0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">country_cut_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>\
                                                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">cut_bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">cut_bbox</span> <span class="o">=</span> <span class="n">_get_country_shape</span><span class="p">(</span><span class="n">country_adm0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">country_cut_mode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cut_bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cut_bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> \
                        <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid bounding box provided. </span><span class="se">\</span>
<span class="s1">                               Bounding box ignored. Please ensure the </span><span class="se">\</span>
<span class="s1">                               bounding box is an array like type of </span><span class="se">\</span>
<span class="s1">                               dimension 1x4&#39;</span><span class="p">)</span>
                <span class="n">cut_bbox</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cut_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cut_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> \
                                                <span class="p">(</span><span class="n">cut_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cut_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid bounding box provided. </span><span class="se">\</span>
<span class="s1">                                   Bounding box ignored. Please make sure </span><span class="se">\</span>
<span class="s1">                                   that the layout of the bounding box is </span><span class="se">\</span>
<span class="s1">                                   (Min_Longitude, Min_Latitude, </span><span class="se">\</span>
<span class="s1">                                    Max_Longitude, Max_Latitude).&#39;</span><span class="p">)</span>
                    <span class="n">cut_bbox</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid bounding box provided. Bounding box </span><span class="se">\</span>
<span class="s1">                           ignored. Please ensure the bounding box is an </span><span class="se">\</span>
<span class="s1">                           array like type.&#39;</span><span class="p">)</span>
            <span class="n">cut_bbox</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">cut_bbox</span>

<span class="k">def</span> <span class="nf">_litpop_scatter</span><span class="p">(</span><span class="n">adm0_data</span><span class="p">,</span> <span class="n">adm1_data</span><span class="p">,</span> <span class="n">adm1_info</span><span class="p">,</span> <span class="n">check_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plots the admin0 share of the states and provinces against the admin1</span>
<span class="sd">        shares.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        adm0_data (list): list containing the admin0 shares</span>
<span class="sd">        adm1_data (list): list containing the admin1 shares</span>
<span class="sd">        adm1_info (list): list containing the shape files of the admin1 items.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adm0_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adm0_data</span><span class="p">)</span>
    <span class="n">adm1_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adm1_data</span><span class="p">)</span>
    <span class="n">inter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">adm1_data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">adm0_data</span><span class="p">))</span>
    <span class="n">adm1_data</span> <span class="o">=</span> <span class="n">adm1_data</span><span class="p">[</span><span class="n">inter</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">adm0_data</span> <span class="o">=</span> <span class="n">adm0_data</span><span class="p">[</span><span class="n">inter</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Correlation coefficients:</span>
    <span class="n">spearmanr</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">adm0_data</span><span class="p">,</span> <span class="n">adm1_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pearsonr</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">adm0_data</span><span class="p">,</span> <span class="n">adm1_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Root mean square error:</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">adm0_data</span><span class="o">-</span><span class="n">adm1_data</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**.</span><span class="mi">5</span>
    <span class="c1"># Relative root mean square error:</span>
    <span class="c1"># rrmse = (sum(((adm0_data-adm1_data)/adm1_data)**2))**.5</span>
    <span class="c1"># Root mean squared fraction:</span>
    <span class="n">rmsf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">adm0_data</span><span class="o">/</span><span class="n">adm1_data</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span> \
                                        <span class="n">adm0_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">check_plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adm1_data</span><span class="p">,</span> <span class="n">adm0_data</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
<span class="c1">#        plt.suptitle(&#39;Comparison of admin0 and admin1 LitPop data for &#39;\</span>
<span class="c1">#                  + adm1_info[0].attributes[&#39;admin&#39;])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]])],</span>\
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]])],</span>\
                  <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;.3&quot;</span><span class="p">)</span>
    <span class="c1">#    plt.annotate(label, xy=(adm0_data, adm1_data), xytext=(-20, 20),</span>
    <span class="c1">#        textcoords=&#39;offset points&#39;, ha=&#39;right&#39;, va=&#39;bottom&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">adm1_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;: rp=&#39;</span>\
                     <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, rs=&#39;</span>\
                     <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="n">spearmanr</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Reference GDP share&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Modelled GDP share&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">spearmanr</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">rmsf</span>

<div class="viewcode-block" id="read_bm_file"><a class="viewcode-back" href="../../../../climada/climada.entity.exposures.html#climada.entity.exposures.litpop.read_bm_file">[docs]</a><span class="k">def</span> <span class="nf">read_bm_file</span><span class="p">(</span><span class="n">bm_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reads a single NASA BlackMarble GeoTiff and returns the data. Run all</span>
<span class="sd">        required checks first.</span>

<span class="sd">        PARAMETERS:</span>
<span class="sd">            bm_path (str): absolute path where files are stored.</span>
<span class="sd">            filename (str): filename of the file to be read.</span>

<span class="sd">        RETURNS:</span>
<span class="sd">            arr1 (array): Raw BM data</span>
<span class="sd">            curr_file (gdal GeoTiff File): Additional info from which</span>
<span class="sd">                coordinates can be calculated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Importing </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bm_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">curr_file</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bm_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">band1</span> <span class="o">=</span> <span class="n">curr_file</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">arr1</span> <span class="o">=</span> <span class="n">band1</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">band1</span>
        <span class="k">return</span> <span class="n">arr1</span><span class="p">,</span> <span class="n">curr_file</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed: Importing </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">curr_file</span><span class="p">))</span>
        <span class="k">raise</span></div>

<div class="viewcode-block" id="get_bm"><a class="viewcode-back" href="../../../../climada/climada.entity.exposures.html#climada.entity.exposures.litpop.get_bm">[docs]</a><span class="k">def</span> <span class="nf">get_bm</span><span class="p">(</span><span class="n">required_files</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">BM_FILENAMES</span><span class="p">),),</span>\
           <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Potential TODO: put cutting before zooming (faster), but with expanding</span>
<span class="sd">    bbox in order to preserve additional pixels for interpolation...&quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot; Reads data from NASA GeoTiff files and cuts out the data along a chosen</span>
<span class="sd">        bounding box. Call this after the functions</span>
<span class="sd">        nightlight.required_nl_files and nightlight.check_nl_local_file_exists</span>
<span class="sd">        have ensured which files are required and which ones exist and missing</span>
<span class="sd">        files have been donwloaded.</span>

<span class="sd">        PARAMETERS:</span>
<span class="sd">            required_files (8x1 array): boolean values which designates which</span>
<span class="sd">                BM files are required. Can be generated by the function</span>
<span class="sd">                nightlight.check_required_nl_files</span>
<span class="sd">        OPTIONAL PARAMTERS</span>
<span class="sd">            cut_bbox (1x4 array-like): Bounding box (ESRI type) to be cut out.</span>
<span class="sd">                the layout of the bounding box corresponds to the bounding box</span>
<span class="sd">                of the ESRI shape files and is as follows:</span>
<span class="sd">                [minimum longitude, minimum latitude, maximum longitude,</span>
<span class="sd">                 maxmimum latitude]</span>
<span class="sd">            country_adm0 (str): Country Code of the country of interest.</span>
<span class="sd">            country_cut_mode (int): Defines how the country is cut out:</span>
<span class="sd">                if 0: the country is only cut out with a bounding box</span>
<span class="sd">                if 1: the country is cut out along it&#39;s borders</span>
<span class="sd">                Default: = 1</span>
<span class="sd">            bm_path (str): absolute path where files are stored.</span>
<span class="sd">            resolution (int): the resolution in arcsec in which the data output</span>
<span class="sd">                is created.</span>
<span class="sd">            return_coords (boolean): Determines whether latitude and longitude</span>
<span class="sd">                are delievered along with gpw data (1) or only bm_data is</span>
<span class="sd">                returned (1) (Default: 0)</span>
<span class="sd">            reference_year (int): Default = 2016</span>

<span class="sd">        RETURNS:</span>
<span class="sd">            nightlight_intensity (pandas SparseArray): BM data</span>
<span class="sd">            lon (list): list with longitudinal infomation on the GPW data. Same</span>
<span class="sd">                dimensionality as tile_temp (only returned if return_coords=1)</span>
<span class="sd">            lat (list): list with latitudinal infomation on the GPW data. Same</span>
<span class="sd">                dimensionality as tile_temp (only returned if return_coords=1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bm_path</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_path&#39;</span><span class="p">,</span> <span class="n">SYSTEM_DIR</span><span class="p">)</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">reference_year</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reference_year&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">_match_target_res</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">cut_bbox</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cut_bbox&#39;</span><span class="p">)</span>
    <span class="n">country_adm0</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;country_adm0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">country_adm0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">country_crop_mode</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">country_crop_mode</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;country_crop_mode&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">return_coords</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_coords&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cut_bbox</span> <span class="o">=</span> <span class="n">_check_bbox_country_cut_mode</span><span class="p">(</span><span class="n">country_crop_mode</span><span class="p">,</span>\
                                                   <span class="n">cut_bbox</span><span class="p">,</span> <span class="n">country_adm0</span><span class="p">)</span>
    <span class="n">nightlight_temp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">file_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">zoom_factor</span> <span class="o">=</span> <span class="mi">15</span><span class="o">/</span><span class="n">resolution</span>  <span class="c1"># Orignal resolution is 15 arc-seconds</span>
    <span class="k">for</span> <span class="n">num_i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">BM_FILENAMES</span><span class="p">[::</span><span class="mi">2</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Due to concat, we have to anlayse the tiles in pairs otherwise the</span>
<span class="sd">        data is concatenated in the wrong order&quot;&quot;&quot;</span>
        <span class="n">arr1</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="c1"># Prepopulate list</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1">#Loop which cycles through the two tiles in each &quot;column&quot;</span>
            <span class="k">if</span> <span class="n">required_files</span><span class="p">[</span><span class="n">num_i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_count</span> <span class="o">=</span> <span class="n">file_count</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">arr1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">curr_file</span> <span class="o">=</span> <span class="n">read_bm_file</span><span class="p">(</span><span class="n">bm_path</span><span class="p">,</span>\
                    <span class="n">BM_FILENAMES</span><span class="p">[</span><span class="n">num_i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">%</span> <span class="nb">min</span><span class="p">(</span><span class="n">BM_YEARS</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">reference_year</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">zoom_factor</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
<span class="c1">#                    LOGGER.debug(&#39;Resizing image according to chosen &#39;\</span>
<span class="c1">#                                + &#39;resolution&#39;)</span>
                    <span class="n">arr1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseDataFrame</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">arr1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">zoom_factor</span><span class="p">,</span>\
                                                 <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arr1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseDataFrame</span><span class="p">(</span><span class="n">arr1</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cut_bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">arr1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_bm_bbox_cutter</span>\
                        <span class="p">(</span><span class="n">arr1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">num_i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">file_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Now get the coordinates</span>
                    <span class="n">geo_t</span> <span class="o">=</span> <span class="n">curr_file</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
                    <span class="n">rastsize_x</span><span class="p">,</span> <span class="n">rastsize_y</span> <span class="o">=</span> <span class="n">curr_file</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">,</span>\
                        <span class="n">curr_file</span><span class="o">.</span><span class="n">RasterYSize</span>
                    <span class="n">minlon</span> <span class="o">=</span> <span class="n">geo_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">minlat</span> <span class="o">=</span> <span class="n">geo_t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">rastsize_x</span><span class="o">*</span><span class="n">geo_t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">rastsize_y</span><span class="o">*</span><span class="n">geo_t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">maxlon</span> <span class="o">=</span> <span class="n">geo_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rastsize_x</span><span class="o">*</span><span class="n">geo_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rastsize_y</span><span class="o">*</span><span class="n">geo_t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">maxlat</span> <span class="o">=</span> <span class="n">geo_t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">geo_t</span> <span class="o">=</span> <span class="n">curr_file</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
                    <span class="c1"># Now get the coordinates</span>
                    <span class="n">rastsize_x</span><span class="p">,</span> <span class="n">rastsize_y</span> <span class="o">=</span> <span class="n">curr_file</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">,</span>\
                        <span class="n">curr_file</span><span class="o">.</span><span class="n">RasterYSize</span>
                    <span class="n">minlon</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span> <span class="n">geo_t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># Only add if they extend the current bbox</span>
                    <span class="n">minlat</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minlat</span><span class="p">,</span> <span class="n">geo_t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">rastsize_x</span><span class="o">*</span><span class="n">geo_t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>\
                                 <span class="o">+</span> <span class="n">rastsize_y</span><span class="o">*</span><span class="n">geo_t</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">maxlon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxlon</span><span class="p">,</span> <span class="n">geo_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rastsize_x</span><span class="o">*</span><span class="n">geo_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>\
                                 <span class="o">+</span> <span class="n">rastsize_y</span><span class="o">*</span><span class="n">geo_t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">maxlat</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxlat</span><span class="p">,</span> <span class="n">geo_t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">curr_file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">arr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">arr1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">arr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">arr1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">arr1</span> <span class="o">=</span> <span class="n">arr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">arr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="n">arr1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">arr1</span> <span class="o">=</span> <span class="n">arr1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">arr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="n">arr1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">arr1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nightlight_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nightlight_temp</span> <span class="o">=</span> <span class="n">arr1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nightlight_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">nightlight_temp</span><span class="p">,</span> <span class="n">arr1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">arr1</span>
    <span class="c1"># LOGGER.debug(&#39;Reducing to one dimension...&#39;)</span>
    <span class="n">nightlight_intensity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">nightlight_temp</span><span class="o">.</span><span class="n">values</span>\
                                          <span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span>\
                                          <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">nightlight_temp</span>
    <span class="k">if</span> <span class="n">return_coords</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cut_bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">minlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">,</span>\
                      <span class="n">maxlon</span><span class="p">,</span>\
                      <span class="n">maxlat</span><span class="p">))</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">_litpop_box2coords</span><span class="p">(</span><span class="n">temp_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">_litpop_box2coords</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_coords</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nightlight_intensity</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">minlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">,</span> <span class="n">maxlat</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">nightlight_intensity</span><span class="p">,</span> <span class="n">out_bbox</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nightlight_intensity</span><span class="p">,</span> <span class="kc">None</span></div>

<span class="k">def</span> <span class="nf">_bm_bbox_cutter</span><span class="p">(</span><span class="n">bm_data</span><span class="p">,</span> <span class="n">curr_file</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Crops the imported blackmarble data to the bounding box to reduce</span>
<span class="sd">        memory foot print during import This is done for each of the eight</span>
<span class="sd">        Blackmarble tiles seperately, therefore, the function needs to know</span>
<span class="sd">        which file is currenlty being treated (curr_file).</span>

<span class="sd">    Optional parameters:</span>
<span class="sd">        bm_data (pandas SparseArray or array): Imported BM data in gridded</span>
<span class="sd">            format</span>
<span class="sd">        curr_file (integer): the file which is currenlty being imported (out</span>
<span class="sd">            of all the eignt BM files) in zero indexing.</span>
<span class="sd">        bbox (array 4x1): Bounding box to which the data should be cropped.</span>
<span class="sd">        resolution (int): The resolution in arcsec with which the data is</span>
<span class="sd">            being imported.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bm_data (pandas SparseArray): Cropped BM data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">fixed_source_resolution</span> <span class="o">=</span> <span class="n">resolution</span>
    <span class="n">deg_per_pix</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">fixed_source_resolution</span><span class="p">)</span>
    <span class="n">minlat</span><span class="p">,</span> <span class="n">maxlat</span><span class="p">,</span> <span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">minlat_tile</span><span class="p">,</span> <span class="n">maxlat_tile</span><span class="p">,</span> <span class="n">minlon_tile</span><span class="p">,</span> <span class="n">maxlon_tile</span> <span class="o">=</span>\
            <span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span> <span class="o">==</span> <span class="n">curr_file</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span>\
            <span class="mi">0</span><span class="o">+</span><span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span> <span class="o">==</span> <span class="n">curr_file</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span><span class="p">,</span>\
            <span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span>
    <span class="k">if</span> <span class="n">minlat</span> <span class="o">&gt;</span> <span class="n">maxlat_tile</span> <span class="ow">or</span> <span class="n">maxlat</span> <span class="o">&lt;</span> <span class="n">minlat_tile</span>\
        <span class="ow">or</span> <span class="n">minlon</span> <span class="o">&gt;</span> <span class="n">maxlon_tile</span> <span class="ow">or</span> <span class="n">maxlon</span> <span class="o">&lt;</span> <span class="n">minlon_tile</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This tile does not contain any relevant data. </span><span class="se">\</span>
<span class="s1">                       Skipping file.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseDataFrame</span><span class="p">()</span>
    <span class="n">bbox_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">minlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">,</span> <span class="n">maxlat</span><span class="p">))</span>
    <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span><span class="p">,</span> <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> \
        <span class="n">_litpop_coords_in_glb_grid</span><span class="p">(</span><span class="n">bbox_conv</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="n">minrow_tile</span><span class="p">,</span> <span class="n">maxrow_tile</span><span class="p">,</span> <span class="n">mincol_tile</span><span class="p">,</span> <span class="n">maxcol_tile</span> <span class="o">=</span>\
        <span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">curr_file</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">),</span>\
        <span class="mi">90</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">curr_file</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span>\
        <span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">),</span> <span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">),</span>\
        <span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span><span class="o">+</span><span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">row_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row_min</span><span class="p">,</span> <span class="n">minrow_tile</span><span class="p">)</span><span class="o">-</span>\
                <span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">curr_file</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">row_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">row_max</span><span class="p">,</span> <span class="n">maxrow_tile</span><span class="p">)</span><span class="o">-</span>\
                <span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">curr_file</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">col_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">col_min</span><span class="p">,</span> <span class="n">mincol_tile</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">col_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">col_max</span><span class="p">,</span> <span class="n">maxcol_tile</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">curr_file</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bm_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">bm_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseDataFrame</span>\
            <span class="p">(</span><span class="n">bm_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_min</span><span class="p">:</span><span class="n">row_max</span><span class="p">,</span> <span class="n">col_min</span><span class="p">:</span><span class="n">col_max</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">row_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">row_max</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">maxlat_tile</span><span class="o">-</span><span class="n">minlat_tile</span><span class="p">)</span>\
                                 <span class="o">-</span><span class="p">(</span><span class="n">deg_per_pix</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">deg_per_pix</span><span class="p">))</span>
        <span class="n">col_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">col_max</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">maxlon_tile</span><span class="o">-</span><span class="n">minlon_tile</span><span class="p">)</span>\
                                  <span class="o">-</span><span class="p">(</span><span class="n">deg_per_pix</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">deg_per_pix</span><span class="p">))</span>
        <span class="n">bm_data</span> <span class="o">=</span> <span class="n">bm_data</span><span class="p">[</span><span class="n">row_min</span><span class="p">:</span><span class="n">row_max</span><span class="p">,</span> <span class="n">col_min</span><span class="p">:</span><span class="n">col_max</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bm_data</span>

<span class="k">def</span> <span class="nf">_get_box_blackmarble</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reads data from NASA GeoTiff files and cuts out the data along a chosen</span>
<span class="sd">        bounding box.</span>
<span class="sd">        PARAMETERS:</span>
<span class="sd">            cut_bbox (1x4 array-like): Bounding box (ESRI type) to be cut out.</span>
<span class="sd">                the layout of the bounding box corresponds to the bounding box</span>
<span class="sd">                of the ESRI shape files and is as follows:</span>
<span class="sd">                [minimum longitude, minimum latitude, maximum longitude,</span>
<span class="sd">                maxmimum latitude]</span>
<span class="sd">        Optional parameters:</span>
<span class="sd">            gpw_path (str): absolute path where files are stored. If the files</span>
<span class="sd">                dont exist, they get saved there. Default: SYSTEM_DIR</span>
<span class="sd">            resolution (int): the resolution in arcsec in which the data output</span>
<span class="sd">                is created.</span>
<span class="sd">            return_coords (boolean): Determines whether latitude and longitude</span>
<span class="sd">                are delievered along with gpw data (1) or only bm_data is</span>
<span class="sd">                returned (1) (Default: 0)</span>
<span class="sd">            reference_year (int): Default: 2016</span>

<span class="sd">        RETURNS:</span>
<span class="sd">            nightlight_intensity (pandas SparseArray): BM data</span>
<span class="sd">            lon (list): list with longitudinal infomation on the GPW data. Same</span>
<span class="sd">                dimensionality as tile_temp (only returned if return_coords=1)</span>
<span class="sd">            lat (list): list with latitudinal infomation on the GPW data. Same</span>
<span class="sd">                dimensionality as tile_temp (only returned if return_coords=1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">reference_year</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reference_year&#39;</span><span class="p">,</span> <span class="mi">2016</span><span class="p">)</span>
    <span class="n">return_coords</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_coords&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">bm_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bm_path&#39;</span><span class="p">,</span> <span class="n">SYSTEM_DIR</span><span class="p">)</span>
    <span class="c1"># Determine required satellite files</span>
    <span class="n">req_sat_files</span> <span class="o">=</span> <span class="n">nightlight</span><span class="o">.</span><span class="n">check_required_nl_files</span>\
        <span class="p">(</span><span class="n">cut_bbox</span><span class="p">)</span>
    <span class="c1"># Check existence of necessary files for BM-year:</span>
    <span class="n">files_exist</span> <span class="o">=</span> <span class="n">nightlight</span><span class="o">.</span><span class="n">check_nl_local_file_exists</span>\
        <span class="p">(</span><span class="n">req_sat_files</span><span class="p">,</span> <span class="n">bm_path</span><span class="p">,</span> \
         <span class="nb">min</span><span class="p">(</span><span class="n">BM_YEARS</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">reference_year</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Download necessary files:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">req_sat_files</span><span class="p">,</span> <span class="n">files_exist</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Downloading </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">req_sat_files</span><span class="p">)</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">files_exist</span><span class="p">))))</span>
            <span class="n">nightlight</span><span class="o">.</span><span class="n">download_nl_files</span><span class="p">(</span><span class="n">req_sat_files</span><span class="p">,</span> <span class="n">files_exist</span><span class="p">,</span>\
                                         <span class="n">dwnl_path</span><span class="o">=</span><span class="n">bm_path</span><span class="p">,</span> \
                                         <span class="n">year</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">BM_YEARS</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">reference_year</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not download missing satellite data files. </span><span class="se">\</span>
<span class="s1">                     Operation aborted.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="c1"># Read corresponding files</span>
    <span class="c1"># LOGGER.debug(&#39;Reading and cropping neccessary BM files.&#39;)</span>
    <span class="n">nightlight_intensity</span> <span class="o">=</span> <span class="n">get_bm</span><span class="p">(</span><span class="n">req_sat_files</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>\
                                  <span class="n">return_coords</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_bbox</span><span class="o">=</span><span class="n">cut_bbox</span><span class="p">,</span>\
                                  <span class="n">bm_path</span><span class="o">=</span><span class="n">bm_path</span><span class="p">,</span> <span class="n">reference_year</span><span class="o">=</span><span class="n">reference_year</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_coords</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">cut_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)))</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">cut_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">resolution</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">nightlight_intensity</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>
    <span class="c1">### TODO: ensure function is efficient if no coords are returned</span>
    <span class="k">return</span> <span class="n">nightlight_intensity</span>

<div class="viewcode-block" id="admin1_validation"><a class="viewcode-back" href="../../../../climada/climada.entity.exposures.html#climada.entity.exposures.litpop.admin1_validation">[docs]</a><span class="k">def</span> <span class="nf">admin1_validation</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">exponents</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get LitPop based exposre for one country or multiple countries</span>
<span class="sd">    using values at reference year. If GDP or income</span>
<span class="sd">    group not available for that year, consider the value of the closest</span>
<span class="sd">    available year.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        country (str): list of countries or single county as a</span>
<span class="sd">            sting. Countries can either be country names (&#39;France&#39;) or</span>
<span class="sd">            country codes (&#39;FRA&#39;), even a mix is possible in the list.</span>
<span class="sd">        methods_name (list of str), i.e.:</span>
<span class="sd">            - [&#39;LitPop&#39; for LitPop,</span>
<span class="sd">            - [&#39;Lit&#39;, &#39;Pop&#39;] for Lit and Pop,</span>
<span class="sd">            - [&#39;Lit3&#39;] for cube of night lights (Lit3)</span>
<span class="sd">        exponents (list of 2-vectors), same length as methods_name i.e.:</span>
<span class="sd">            - [[1, 1]] for LitPop,</span>
<span class="sd">            - [[1, 0], [0, 1]] for Lit and Pop,</span>
<span class="sd">            - [[3, 0]] for cube of night lights (Lit3)</span>
<span class="sd">    args: Keyword arguments. The following keywords are recognised:</span>
<span class="sd">        res_km (float, optional): approx resolution in km. Default: 1km.</span>
<span class="sd">        res_arcsec (float, optional): resolution in arc-sec. Overrides</span>
<span class="sd">            res_km if both are delivered</span>
<span class="sd">        check_plot (boolean, optional): choose if a plot is shown at the</span>
<span class="sd">            end of the operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res_km</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;res_km&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">res_arcsec</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;res_arcsec&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">check_plot</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_plot&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">fin_mode</span> <span class="o">=</span> <span class="s1">&#39;gdp&#39;</span>
    <span class="n">reference_year</span> <span class="o">=</span> <span class="mi">2015</span>
    <span class="c1">#        inherit_admin1_from_admin0 = args.get(&#39;inherit_admin1_from_admin0&#39;, 1)</span>
    <span class="k">if</span> <span class="n">res_arcsec</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_km</span><span class="o">/</span><span class="n">DEF_RES_GPW_KM</span><span class="p">)</span><span class="o">*</span><span class="n">DEF_RES_GPW_ARCSEC</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="n">res_arcsec</span>
    <span class="n">_match_target_res</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">country_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">admin1_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Preparing coordinates, nightlights, and gpw data at </span><span class="si">%s</span><span class="s1"> arcsec.&#39;</span><span class="p">,</span> \
                <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1">#multiple countries</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No valid country chosen. Give country as string.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1">#One country</span>
        <span class="n">country_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">country_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
        <span class="n">country_new</span> <span class="o">=</span> <span class="n">_get_iso3</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
        <span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">country_new</span>
        <span class="n">cut_bbox</span> <span class="o">=</span> <span class="n">_get_country_shape</span><span class="p">(</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">country_info</span><span class="p">[</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">admin1_info</span><span class="p">[</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>\
            <span class="o">=</span> <span class="n">_get_country_info</span><span class="p">(</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Country parameter data type not recognised. &#39;</span>\
                     <span class="o">+</span> <span class="s1">&#39;Operation aborted.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span>
    <span class="n">shp_file</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
                                         <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
                                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_0_countries&#39;</span><span class="p">)</span>
    <span class="n">shp_file</span> <span class="o">=</span> <span class="n">shapereader</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">shp_file</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cntry_iso</span><span class="p">,</span> <span class="n">cntry_val</span> <span class="ow">in</span> <span class="n">country_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># get GDP value for country</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">gdp_val</span> <span class="o">=</span> <span class="n">gdp</span><span class="p">(</span><span class="n">cntry_iso</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">,</span> <span class="n">shp_file</span><span class="p">)</span>
        <span class="n">cntry_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gdp_val</span><span class="p">)</span>
    <span class="n">_get_gdp2asset_factor</span><span class="p">(</span><span class="n">country_info</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">,</span> <span class="n">shp_file</span><span class="p">,</span> <span class="n">fin_mode</span><span class="o">=</span><span class="n">fin_mode</span><span class="p">)</span>
    <span class="n">curr_shp</span> <span class="o">=</span> <span class="n">_get_country_shape</span><span class="p">(</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">all_coords</span> <span class="o">=</span> <span class="n">_litpop_box2coords</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">_mask_from_shape</span><span class="p">(</span><span class="n">curr_shp</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>\
                            <span class="n">points2check</span><span class="o">=</span><span class="n">all_coords</span><span class="p">)</span>

    <span class="c1"># Get LitPop, Lit and Pop, etc:</span>
    <span class="n">nightlights</span> <span class="o">=</span> <span class="n">_get_box_blackmarble</span><span class="p">(</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">reference_year</span><span class="o">=</span><span class="n">reference_year</span><span class="p">,</span> \
                                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">return_coords</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">bm_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nightlights</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
     <span class="c1"># Lit = Lit + 1 if Population is included, c.f. int(exponents[1]&gt;0):</span>
    <span class="n">bm_temp</span><span class="p">[</span><span class="n">nightlights</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nightlights</span><span class="o">.</span><span class="n">sp_values</span><span class="p">,</span> \
           <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">nightlights</span>

    <span class="n">nightlights0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">bm_temp</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nightlights0</span> <span class="o">=</span> <span class="n">nightlights0</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">nightlights1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">SparseArray</span><span class="p">(</span><span class="n">bm_temp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">bm_temp</span>
    <span class="n">nightlights1</span> <span class="o">=</span> <span class="n">nightlights1</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>

    <span class="n">gpw</span> <span class="o">=</span> <span class="n">gpw_import</span><span class="o">.</span><span class="n">get_box_gpw</span><span class="p">(</span><span class="n">cut_bbox</span><span class="o">=</span><span class="n">cut_bbox</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>\
                              <span class="n">return_coords</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reference_year</span><span class="o">=</span><span class="n">reference_year</span><span class="p">)</span>
    <span class="n">gpw</span> <span class="o">=</span> <span class="n">gpw</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>

    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_coords</span><span class="p">)[</span><span class="n">mask</span><span class="o">.</span><span class="n">sp_index</span><span class="o">.</span><span class="n">indices</span><span class="p">])</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Caclulating admin1 masks...&#39;</span><span class="p">)</span>
    <span class="n">masks_adm1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">adm1_shp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">admin1_info</span><span class="p">[</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
        <span class="n">masks_adm1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mask_from_shape</span><span class="p">(</span><span class="n">adm1_shp</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>\
                  <span class="n">points2check</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)))</span>
    <span class="n">n_scores</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span><span class="o">*</span><span class="n">n_scores</span><span class="p">)</span>
    <span class="n">adm0</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">adm1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loop through methods...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">methods</span><span class="p">)):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">exponents</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Lit only, use Lit in [0, 255]</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">_LitPop_multiply</span><span class="p">(</span><span class="n">nightlights0</span><span class="p">,</span> <span class="n">gpw</span><span class="p">,</span> <span class="n">exponents</span><span class="o">=</span><span class="n">exponents</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Pop is used, use Lit+1 in [1, 256]</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">_LitPop_multiply</span><span class="p">(</span><span class="n">nightlights1</span><span class="p">,</span> <span class="n">gpw</span><span class="p">,</span> <span class="n">exponents</span><span class="o">=</span><span class="n">exponents</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n_scores</span><span class="p">:(</span><span class="n">i</span><span class="o">*</span><span class="n">n_scores</span><span class="p">)</span><span class="o">+</span><span class="n">n_scores</span><span class="p">],</span> <span class="n">adm0</span><span class="p">[</span><span class="n">methods</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">adm1</span><span class="p">[</span><span class="n">methods</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">_calc_admin1</span><span class="p">(</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>\
                <span class="n">country_info</span><span class="p">[</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">admin1_info</span><span class="p">[</span><span class="n">country_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>\
                <span class="n">_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)),</span> <span class="n">resolution</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">conserve_cntrytotal</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> \
                <span class="n">check_plot</span><span class="o">=</span><span class="n">check_plot</span><span class="p">,</span> <span class="n">masks_adm1</span><span class="o">=</span><span class="n">masks_adm1</span><span class="p">,</span> <span class="n">return_data</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rho</span><span class="p">,</span> <span class="n">adm0</span><span class="p">,</span> <span class="n">adm1</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../../../search.html">search</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, ETH Zurich.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>